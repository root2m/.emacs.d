#+TITLE: LMM Emacs Config
#+AUTHOR: Lmm
#+STARTUP: content indent

* TANGLE CONFIG
#+BEGIN_SRC emacs-lisp
;;; EmacsConfig.el -*- lexical-binding: t; -*-
#+END_SRC

* COMMENT OPEN DEBUG
#+BEGIN_SRC emacs-lisp
(setq debug-on-error t)
#+END_SRC

* BOOT CONFIG
* CORE SETTINGS
** Fast Read
#+BEGIN_SRC emacs-lisp
  ;; Increase how much is read from processes in a single chunk (default is 4kb)
  (setq read-process-output-max (* 4 1024 1024))
#+END_SRC

** COMMENT Init time
#+BEGIN_SRC emacs-lisp
  (add-hook 'emacs-startup-hook
            (lambda ()
              (message "*** Emacs loaded in %s with %d garbage collections."
                       (format "%.2f seconds"
                               (float-time
                                (time-subtract after-init-time before-init-time)))
                       gcs-done)))
#+END_SRC

** Custom file
#+BEGIN_SRC emacs-lisp
(setq custom-file (locate-user-emacs-file "custom.el"))
#+END_SRC

** Open Config file
#+BEGIN_SRC emacs-lisp
  (defun open-init-file()
    (interactive)
    (find-file (concat user-emacs-directory "init.el")))
  (defun open-config-org-file()
    (interactive)
    (find-file (concat user-emacs-directory "EmacsConfig.org")))
  (global-set-key (kbd "<f2>") 'open-config-org-file)
#+END_SRC

** Default Coding System
#+BEGIN_SRC emacs-lisp
  (set-language-environment "UTF-8")
  (set-default-coding-systems 'utf-8)
#+END_SRC

** Server Mode
#+BEGIN_SRC emacs-lisp
  (with-eval-after-load 'server
    (unless (server-running-p)(server-start)))
#+END_SRC

** Native Comp Support
#+BEGIN_SRC emacs-lisp
  ;; åˆ¤æ–­æ˜¯å¦æ”¯æŒnative-comp
  (when (featurep 'native-compile)
    ;; å…³é—­native-comp ç”Ÿæˆçš„è­¦å‘Š
    (setq native-comp-async-report-warnings-errors nil)
    ;; åŒæ­¥ç¼–è¯‘
    (setq native-comp-deferred-compilation t)
    ;; è‡ªå®šä¹‰ native comp ç¼“å­˜ç”Ÿæˆè·¯å¾„
    (add-to-list 'native-comp-eln-load-path (expand-file-name "eln-cache/" user-emacs-directory))
    (setq package-native-compile t))
#+END_SRC

** Yes Or No
#+BEGIN_SRC emacs-lisp
  (setq use-short-answers t)
  (unless (>= emacs-major-version 28)
    (fset 'yes-or-no-p 'y-or-n-p))
  (setq y-or-n-p-use-read-key t
        ;;ç¦æ­¢åˆ‡æ¢ä»é€‰æ‹©ä¸­å‡ºæ¥
        read-char-choice-use-read-key t)
  ;; æ›´å¤šçš„é€‰é¡¹
  (defmacro lmm/read-char-choice (format choices)
    "More option to question. CHOICES is a list
     exp:
     (lmm/read-char-choice format ((?a (body)) (?b (body)) ...))"
            (declare (indent 1) (debug t))
            (let ((ch-list (mapcar (lambda (l)(car l)) choices)))
              `(let ((ch (read-char-choice ,format ',ch-list)))
                 (cond ,@(mapcar (lambda (c) (let ((c (car c))
                                            (body (cdr c)))
                                        (cons (list '= c 'ch) body))) choices)))))
#+END_SRC

** System Clipboard
#+BEGIN_SRC emacs-lisp
  ;; å½“å˜é‡ä¸º t æ—¶ï¼Œevil ç²˜è´´å¤±æ•ˆ
  (setq select-enable-primary nil)
  ;; å¼€å¯ç³»ç»Ÿå‰ªè´´æ¿
  (setq select-enable-clipboard t)
#+END_SRC

** Enable Narrow Commands -- åªå¯¹ç›®æ ‡è¿›è¡Œç¼–è¾‘
#+BEGIN_SRC emacs-lisp
  (put 'narrow-to-defun  'disabled nil)
  (put 'narrow-to-page   'disabled nil)
  (put 'narrow-to-region 'disabled nil)
#+END_SRC

* PACKAGE MANAGEMENT
** Setup package.el to work with MELPA.
ä¿®æ”¹å›½å†…é•œåƒæº
#+BEGIN_SRC emacs-lisp
  ;; (require 'package)
  (setq package-archives '(("gnu"   . "https://elpa.zilongshanren.com/gnu/")
                           ("melpa" . "https://elpa.zilongshanren.com/melpa/")
                           ("org" . "https://elpa.zilongshanren.com/org/")))
  ;; åˆå¹¶ autoload io å¿«é€Ÿå¯åŠ¨ï¼Œå¦‚æœæ–°å®‰è£…åŒ…äº†ä¹‹åéœ€è¦æ‰§è¡Œ package-quickstart-refresh
  (setq package-quickstart t)
  ;; (package-refresh-contents)
#+END_SRC

** Straight -- git package manager
#+BEGIN_SRC emacs-lisp
  (setq straight-check-for-modifications 'never)
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 5))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
  (add-to-list 'straight-built-in-pseudo-packages 'org)
#+END_SRC

** Installing use-package
åŒ…ç®¡ç†å™¨
#+BEGIN_SRC emacs-lisp
  (straight-use-package 'use-package)
  ;; (unless (package-installed-p 'use-package)
  ;;   (package-initialize)
  ;;   (package-refresh-contents)
  ;;   (package-install 'use-package))
  (setq use-package-hook-name-suffix nil) ;;åœæ­¢åœ¨:hook å½“ä¸­æ·»åŠ -hookåç¼€
  ;; ;; å¯åŠ¨æ—¶æ˜¾ç¤ºåŒ…åŠ è½½ä¿¡æ¯è‡³ *Message*
  ;; ;; (setq use-package-verbose t)
  (eval-when-compile
    (require 'use-package))
#+END_SRC

** COMMENT Use-Package Man
#+BEGIN_SRC emacs-lisp
  (use-package some-package-name
    :disabled ;;åœæ­¢åŠ è½½ä¸ä½¿ç”¨çš„å†…å®¹
    :no-require t; ä¸åŠ è½½
    :straight t ;;ç¡®ä¿è½¯ä»¶åŒ…ä¼šè‡ªåŠ¨å®‰è£…
    :defer t ;;å»¶è¿Ÿtç§’åŠ è½½åŒ…ï¼ˆrequire 'some-package-name)
    :init () ;;åŠ è½½åŒ…ä¹‹å‰æ‰§è¡Œçš„ä»£ç 
    :config () ;;åŠ è½½åŒ…ä¹‹åæ‰§è¡Œçš„ä»£ç 
    :hook () ;;é’©å­, é»˜è®¤å¯ç”¨ defer t
    :commands command-example ;;å»¶è¿ŸåŠ è½½ï¼Œå‘½ä»¤è§¦å‘
    )
#+END_SRC

** Install diminish, bind-key, gcmh
#+BEGIN_SRC emacs-lisp
  (use-package diminish
    :straight t
    )
  (use-package bind-key
    :straight t)

  ;; åƒåœ¾å›æ”¶
  (use-package gcmh
    :straight t
    :config
    (gcmh-mode))
#+END_SRC

* HELP
** Default Help System
#+BEGIN_SRC emacs-lisp
  (use-package help
    :init
    ;; è‡ªåŠ¨è·å–ç„¦ç‚¹
    (setq help-window-select t)
    :commands help
    :config
    (add-hook 'help-mode-hook (lambda ()(setq-local mode-line-format nil))))
#+END_SRC

** Helpful -- æ›´å¥½çš„å¸®åŠ©ä¿¡æ¯
#+BEGIN_SRC emacs-lisp
  (use-package helpful
    :straight t
    :bind
    (:map help-map
          ("SPC" . helpful-at-point)
          ("f" . helpful-callable)
          ("F" . helpful-function)
          ("v" . helpful-variable)
          ("k" . helpful-key)
          ("C" . helpful-command))
    :init
    (setq helpful-max-buffers 2)
    (setq helpful-switch-buffer-function
          (lambda (buffer-name &rest args)
            (if (equal major-mode 'helpful-mode)
                (pop-to-buffer buffer-name '((display-buffer-same-window)))
              (pop-to-buffer buffer-name '((display-buffer-at-bottom) . ((window-height . 0.4)))))))
    :config
    (add-hook 'helpful-mode-hook (lambda()(setq-local mode-line-format nil))))
#+END_SRC

** elisp-demos -- elisp ä¾‹å­
#+BEGIN_SRC emacs-lisp
  (use-package elisp-demos
    :defer t
    :straight t
    :config
    (advice-add 'describe-function-1 :after #'elisp-demos-advice-describe-function-1)
    (advice-add 'helpful-update :after #'elisp-demos-advice-helpful-update))
#+END_SRC

* KEY BIND
** Simple Key Bind
[[https://github.com/noctuid/general.el][General]] ç›´è§‚çš„æŒ‰é”®ç»‘å®š
#+BEGIN_SRC emacs-lisp
  (use-package general
    :straight t
    :config
    (general-evil-setup t))
#+END_SRC
#+BEGIN_SRC emacs-lisp
  ;; ESC Cancels All
 (global-set-key (kbd "<escape>") 'keyboard-escape-quit)

  ;; Rebind C-u
  (global-set-key (kbd "C-M-u") 'universal-argument)
#+END_SRC

** Hydra
#+BEGIN_SRC emacs-lisp
  (use-package hydra
    :straight t
    :config)
#+END_SRC

** Mouse Key Bind
#+BEGIN_SRC emacs-lisp
  (unless (< emacs-major-version 29)
    (setq pixel-scroll-precision-large-scroll-height 10)
    (setq pixel-scroll-precision-interpolation-factor 10)
    (add-hook 'after-init-hook 'pixel-scroll-precision-mode))
#+END_SRC

* UI
** Display Line Numbers and Truncated Lines
#+BEGIN_SRC emacs-lisp
  (global-visual-line-mode t)

  (setq-default display-line-numbers-type 'relative
        display-line-numbers-width 3
        display-line-numbers-widen t)
  ;; Enable line numbers for some modes
  ;; å¼€å¯è¡Œå·æ˜¾ç¤º
  (dolist (mode '(text-mode-hook
                  prog-mode-hook
                  conf-mode-hook))
    (add-hook mode (lambda () (display-line-numbers-mode 1))))

  ;; Override some modes which derive from the above
  (dolist (mode '(org-mode-hook))
    (add-hook mode (lambda () (display-line-numbers-mode 0))))
  ;; è®¾ç½®ç›¸å¯¹è¡Œå·


  ;; (use-package simple
  ;;   :config
  ;;   (progn
  ;;     ;; å…³é—­å½“å‰è¡Œé«˜äº®
  ;;     (global-hl-line-mode -1)))
   #+END_SRC

** Cursor Face
#+BEGIN_SRC emacs-lisp
  (blink-cursor-mode -1)
  (defun lmm/cursor-I-am-here ()
    "cursor, where are you ???"
    (interactive)
    )
#+END_SRC

** Bell
*** COMMENT bell modeline color
#+BEGIN_SRC emacs-lisp
  (setq ring-bell-function
        (lambda ()
          (let ((orig-fg (face-background 'mode-line)))
            (set-face-background 'mode-line "#a8910f")
            (run-with-idle-timer 0.1 nil
                                 (lambda (fg) (set-face-background 'mode-line fg))
                                 orig-fg))))
#+END_SRC

*** visible bell
#+BEGIN_SRC emacs-lisp
  (setq visible-bell nil)
  (setq ring-bell-function 'ignore)
#+END_SRC

** 80 line
#+BEGIN_SRC emacs-lisp
  (when (boundp 'display-fill-column-indicator)
    (setq-default indicate-buffer-boundaries 't)
    (setq-default fill-column 80)
    ;; (add-hook 'prog-mode-hook 'display-fill-column-indicator-mode)
    )
#+END_SRC

** Icon Display
#+BEGIN_SRC emacs-lisp
  (use-package all-the-icons
    :straight t)
#+END_SRC

** Dashboard
#+BEGIN_SRC emacs-lisp
  (use-package dashboard
    :straight t
    ;; :hook (after-init-hook . dashboard-setup-startup-hook)
    :init
    ;; å±…ä¸­å¯¹é½
    (setq dashboard-center-content t
          dashboard-set-footer nil
          dashboard-startup-banner 'logl
          dashboard-banner-logo-title nil)
    ;;(setq dashboard-show-shortcuts nil)
    (setq dashboard-items '((recents  . 5)
                            (projects . 5)
                            (bookmarks . 5)
                            (agenda . 5)
                            (registers . 5)))
    ;; å¯ç”¨å›¾æ ‡
    (setq dashboard-set-heading-icons t)
    (setq dashboard-set-file-icons t)
    ;; ä¸»é¡µè®¾ç½®
    (setq dashboard-set-navigator t)
    ;; Format: "(icon title help action face prefix suffix)"
    (setq dashboard-navigator-buttons
          `(;; line1
            ((,(all-the-icons-octicon "mark-github" :height 1.1 :v-adjust 0.0)
              ""
              "Git Homepage"
              (lambda (&rest _) (if (string-match "WSL" operating-system-release)
                                    (shell-command "/mnt/c/Windows/explorer.exe https://github.com/Littlemanman " nil nil)
                                    (browse-url "https://github.com/Littlemanman"))))
             ;; ("â˜…" "Star" "Show stars" (lambda (&rest _) (show-stars)) warning)
             ;; ("?" "" "?/h" #'show-help nil "<" ">")
             )
            ;; line 2
            ;; ((,(all-the-icons-faicon "linkedin" :height 1.1 :v-adjust 0.0)
            ;;   "Linkedin"
            ;;   ""
            ;;   (lambda (&rest _) (browse-url "homepage")))
            ;;  ("âš‘" nil "Show flags" (lambda (&rest _) (message "flag")) error))
            ))
    :config
    ;;å¯ç”¨dashboard
    (dashboard-setup-startup-hook)
    ;; emacsclientå¯åŠ¨æ—¶ä¸ºdashboard
    (setq initial-buffer-choice '(lambda () (get-buffer "*dashboard*")))
    )
#+END_SRC

** Posframe
#+BEGIN_SRC emacs-lisp
  (use-package posframe
    :straight t
    :defer t
    )
#+END_SRC

** Face Theme
#+BEGIN_SRC emacs-lisp
  (use-package doom-themes
    :straight t
    :config
    ;; Global settings (defaults)
    (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
          doom-themes-enable-italic t) ; if nil, italics is universally disabled
    (load-theme 'doom-dracula t)
    ;; Treemacs hl-line-mode bug
    (set-face-background 'line-number-current-line "#282a36")
    ;; (doom-themes-visual-bell-config)
   )
#+END_SRC

** Modeline Config
#+BEGIN_SRC emacs-lisp
  (use-package doom-modeline
    :straight t
    :init
    (setq doom-modeline-modal-icon nil)
    :hook
    (after-init-hook . doom-modeline-mode))

  (use-package moody
    :disabled
    :no-require t
    :straight t
    :config
    (setq x-underline-at-descent-line t)
    (moody-replace-mode-line-buffer-identification)
    (moody-replace-vc-mode)
    (moody-replace-eldoc-minibuffer-message-function)
    )
#+END_SRC

** Pair Color Config
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters
    :straight t
    :hook
    (prog-mode-hook . rainbow-delimiters-mode))
#+END_SRC

** Fonts
#+BEGIN_SRC emacs-lisp
  ;; å­—ä½“è®¾ç½®
  (cond ((member "JetBrainsMono Nerd Font" (font-family-list))
         (add-to-list 'default-frame-alist '(font . "JetBrainsMono Nerd Font-13")))
        ((member "Fira Code" (font-family-list))
         (add-to-list 'default-frame-alist '(font . "Fira Code-13")))
        ((member "Source Code Pro" (font-family-list))
         (add-to-list 'default-frame-alist '(font . "Source Code Pro-13"))))
  ;; (add-to-list 'initial-frame-alist '(font . "Fira Code"))
  (if (member "HarmonyOS Sans SC" (font-family-list))
      (set-fontset-font t 'han "HarmonyOS Sans SC"))

  (setq-default line-spacing nil)
  ;; (set-face-attribute 'default nil
  ;;                     :font "Sarasa Mono SC Nerd"
  ;;                     ;; :slant 'normal
  ;;                     ;; :weight 'normal
  ;;                     :height 130
  ;;                     ;; :width 'normal
  ;;                     )
  ;; Fira Code Symbol å­—ç¬¦é›†
  ;; www  \ue100     **   \ue101    ***  \ue102    **/  \ue103
  ;;  *>  \ue104     */   \ue105     \\  \ue106    \\\  \ue107
  ;;  {-  \ue108     []   \ue109     ::  \ue10a    :::  \ue10b
  ;;  :=  \ue10c     !!   \ue10d     !=  \ue10e    !==  \ue10f
  ;;  -}  \ue110     --   \ue111    ---  \ue112    -->  \ue113
  ;;  ->  \ue114    ->>   \ue115     -<  \ue116    -<<  \ue117
  ;;  -~  \ue118     #{   \ue119     #[  \ue11a     ##  \ue11b
  ;; ###  \ue11c   ####   \ue11d     #(  \ue11e     #?  \ue11f
  ;;  #_  \ue120    #_(   \ue121     .-  \ue122     .=  \ue123
  ;;  ..  \ue124    ..<   \ue125    ...  \ue126     ?=  \ue127
  ;;  ??  \ue128     ;;   \ue129     /*  \ue12a    /**  \ue12b
  ;;  /=  \ue12c    /==   \ue12d     />  \ue12e     //  \ue12f
  ;; ///  \ue130     &&   \ue131     ||  \ue132    ||=  \ue133
  ;;  |=  \ue134     |>   \ue135     ^=  \ue136     $>  \ue137
  ;;  ++  \ue138    +++   \ue139     +>  \ue13a     +>  \ue13a
  ;; =:=  \ue13b     ==   \ue13c    ===  \ue13d    ==>  \ue13e
  ;;  =>  \ue13f    =>>   \ue140     <=  \ue141    =<<  \ue142
  ;; =/=  \ue143     >-   \ue144     >=  \ue145    >=>  \ue146
  ;;  >>  \ue147    >>-   \ue148    >>=  \ue149    >>>  \ue14a
  ;;  <*  \ue14b    <*>   \ue14c     <|  \ue14d    <|>  \ue14e
  ;;  <$  \ue14f    <$>   \ue150   <!--  \ue151     <-  \ue152
  ;; <--  \ue153    <->   \ue154     <+  \ue155    <+>  \ue156
  ;;  <=  \ue157    <==   \ue158    <=>  \ue159    <=<  \ue15a
  ;;  <>  \ue15b     <<   \ue15c    <<-  \ue15d    <<=  \ue15e
  ;; <<<  \ue15f     <~   \ue160    <~~  \ue161     </  \ue162
  ;; </>  \ue163     ~@   \ue164     ~-  \ue165     ~=  \ue166
  ;;  ~>  \ue167     ~~   \ue168    ~~>  \ue169     %%  \ue16a
  ;;   x  \ue16b      :   \ue16c      +  \ue16d      *  \ue16f
  ;; (when (member "Fira Code Symbol" (font-family-list))
  ;;   (set-fontset-font t '(#Xe100 . #Xe16f) "Fira Code Symbol"))

  ;; Install Doc: https://github.com/tonsky/FiraCode/wiki/Emacs-instructions
  (defun fira-code-mode--make-alist (list)
    "Generate prettify-symbols alist from LIST."
    (let ((idx -1))
      (mapcar
       (lambda (s)
         (setq idx (1+ idx))
         (let* ((code (+ #Xe100 idx))
            (width (string-width s))
            (prefix ())
            (suffix '(?\s (Br . Br)))
            (n 1))
       (while (< n width)
         (setq prefix (append prefix '(?\s (Br . Bl))))
         (setq n (1+ n)))
       (cons s (append prefix suffix (list (decode-char 'ucs code))))))
       list)))

  (defconst fira-code-mode--ligatures
    '("www" "**" "***" "**/" "*>" "*/" "\\\\" "\\\\\\"
      "{-" "[]" "::" ":::" ":=" "!!" "!=" "!==" "-}"
      "--" "---" "-->" "->" "->>" "-<" "-<<" "-~"
      "#{" "#[" "##" "###" "####" "#(" "#?" "#_" "#_("
      ".-" ".=" ".." "..<" "..." "?=" "??" ";;" "/*"
      "/**" "/=" "/==" "/>" "//" "///" "&&" "||" "||="
      "|=" "|>" "^=" "$>" "++" "+++" "+>" "=:=" "=="
      "===" "==>" "=>" "=>>" "<=" "=<<" "=/=" ">-" ">="
      ">=>" ">>" ">>-" ">>=" ">>>" "<*" "<*>" "<|" "<|>"
      "<$" "<$>" "<!--" "<-" "<--" "<->" "<+" "<+>" "<="
      "<==" "<=>" "<=<" "<>" "<<" "<<-" "<<=" "<<<" "<~"
      "<~~" "</" "</>" "~@" "~-" "~=" "~>" "~~" "~~>" "%%"
      "x" ":" "+" "+" "*"))

  (defvar fira-code-mode--old-prettify-alist)

  (defun fira-code-mode--enable ()
    "Enable Fira Code ligatures in current buffer."
    (if (member "Fira Code Symbol" (font-family-list))
     (progn
       (setq-local fira-code-mode--old-prettify-alist prettify-symbols-alist)
       (setq-local prettify-symbols-alist (append (fira-code-mode--make-alist fira-code-mode--ligatures) fira-code-mode--old-prettify-alist))
       (prettify-symbols-mode t))
     (user-error "Fira Code Symbol Not Found, Enable Failed")))

  (defun fira-code-mode--disable ()
    "Disable Fira Code ligatures in current buffer."
    (setq-local prettify-symbols-alist fira-code-mode--old-prettify-alist)
    (prettify-symbols-mode -1))

  (define-minor-mode fira-code-mode
    "Fira Code ligatures minor mode"
    :lighter " Fira Code"
    (setq-local prettify-symbols-unprettify-at-point 'right-edge)
    (if fira-code-mode
        (fira-code-mode--enable)
      (fira-code-mode--disable)))

  (defun fira-code-mode--setup ()
    "Setup Fira Code Symbols"
    (set-fontset-font t '(#Xe100 . #Xe16f) "Fira Code Symbol"))

  ;; (add-hook 'prog-mode-hook 'fira-code-mode)

  (defhydra hydra-text-scale()
    "Change font size"
    ;; å‡å°å­—ä½“
    ("j" text-scale-increase "Text Scale Increase")
    ;; å¢å¤§å­—ä½“
    ("k" text-scale-decrease "Text Scale Decrease")
    ;; text-scale-adjust æŒ‰é”®ç›‘å¬ï¼Œï¼‹ ï¼ æˆ– 0 é‡ç½®ï¼Œq é€€å‡º
    ("q" nil "Quit ! ! !"))

#+END_SRC

** Whitespace Config
#+BEGIN_SRC emacs-lisp
  (setq-default show-trailing-whitespace nil)
  (defun lmm/show-trailing-whitespace()
    "Enable display of trailing whitespace in this buffer."
    (setq-local show-trailing-whitespace t))
  (dolist (hook '(prog-mode-hook text-mode-hook conf-mode-hook))
          (add-hook hook 'lmm/show-trailing-whitespace))

  ;; (dolist (hook '(emacs-lisp-mode-hook))
  ;;   (add-hook hook (lambda()
  ;;                    "Enable highlight whitespace"
  ;;                    (setq-local whitespace-style
  ;;                                ;; trailing : enable highlight trail space
  ;;                                '(face trailing lines-tail)
  ;;                                ;; '(face lines-tail)
  ;;                                whitespace-line-column 80)
  ;;                    (whitespace-mode t))))


  ;; (dolist (hook '(org-mode-hook text-mode-hook))
  ;;   (add-hook hook (lambda ()
  ;;                    "Enable highlight whitespace"
  ;;                    (setq-local whitespace-style
  ;;                                ;; trailing : enable highlight trail space
  ;;                                '(face trailing)
  ;;                                ;; '(face lines-tail)
  ;;                                )
  ;;                    (whitespace-mode t))))
#+END_SRC

** COMMENT Symbol Highlight
#+BEGIN_SRC emacs-lisp
  (use-package auto-highlight-symbol
    :straight t)
#+END_SRC

** Beautiful Code
*** COMMENT svg-tag-mode
#+BEGIN_SRC emacs-lisp
  (use-package svg-tag-mode
    :disabled
    :no-require t
    :straight t
    :config
    (setq svg-tag-tags
          '(
            (":TODO:" . ((lambda (tag) (svg-tag-make tag :beg 1 :end -1))))
            )))
#+END_SRC

*** hl-todo
#+BEGIN_SRC emacs-lisp
  (use-package hl-todo
    :straight t
    :hook
    (after-init-hook . global-hl-todo-mode))
#+END_SRC

*** COMMENT highlight indent
#+BEGIN_SRC emacs-lisp

#+END_SRC

* EVIL MODE
** Evil Core
#+BEGIN_SRC emacs-lisp
  (use-package evil
    :straight t
    :init
    (add-hook 'after-init-hook 'evil-mode)
    ;;
    (setq evil-want-integration t
          ;; åœ¨å…¶ä»–æ¨¡å¼åŠ è½½vimé»˜è®¤é”®ç»‘å®š
          evil-want-keybinding nil
          evil-vsplit-window-right t
          evil-split-window-below t
          evil-want-C-u-delete t
          evil-want-C-u-scroll t
          evil-want-C-w-delete t
          evil-want-C-i-jump t
          evil-want-Y-yank-to-eol t
          ;; undo-treeæ—¶ä¼šå‡ºç°æœªçŸ¥å¡é¡¿
          evil-undo-system 'undo-redo
          ;; ç¦æ­¢åœ¨ ex å‘½ä»¤å½“ä¸­è¡¥å…¨ emacs å‘½ä»¤
          evil-ex-complete-emacs-commands nil
          ;; ä½¿ç”¨ emacs æœ¬èº«çš„æ’¤é”€æ¨¡å¼
          evil-want-fine-undo t
          ;; ç²˜è´´æ›¿æ¢é€‰ä¸­æ–‡æœ¬ä¸åŠ å…¥ kill ring ä¸­
          evil-kill-on-visual-paste nil
          evil-echo-state nil
          evil-search-module 'evil-search
          evil-visual-char-tag "ğŸ†…"
          evil-normal-state-tag "ğŸ…½"
          evil-insert-state-tag "ğŸ…¸"
          evil-visual-line-tag "ğŸ…»"
          evil-visual-block-tag "ğŸ…±"
          evil-motion-state-tag "ğŸ…¼"
          evil-emacs-state-tag "ğŸ…´"
          evil-operator-state-tag "ğŸ…¾"
          evil-replace-state-tag "ğŸ†"
          evil-visual-screen-line-tag "ğŸ†‚")

    :config
    (general-define-key
     :states 'insert
     "j" (general-key-dispatch 'self-insert-command
           :timeout 0.1
           "k" 'evil-normal-state
           "l" 'toggle-input-method))
    ;; è‡ªå®šä¹‰ escape
    (defun lmm/evil-escape ()
      (when (evil-insert-state-p)
        (let* ((modified (buffer-modified-p))
               (fkey "j")
               (skey "k")
               (evt (read-event nil nil 0.2)))
          (cond ((and (characterp evt)
                      (equal fkey (this-command-keys))
                      (equal skey (char-to-string evt)))
                 (delete-char -1)
                 (set-buffer-modified-p modified)
                 (evil-normal-state))
                ((null evt))
                (t (setq unread-command-events
                         (append unread-command-events (list evt))))))))

    (setq evil-emacs-state-modes nil)
    (setq evil-insert-state-modes nil)
    (setq evil-motion-state-modes nil)

    (setq evil-visual-state-cursor 'hollow)
    (setq evil-normal-state-cursor '(box "cyan"))
    ;;æ¸…ç©ºæ’å…¥æ¨¡å¼çš„æŒ‰é”®
    ;; (setcdr evil-insert-state-map nil)
    ;; å®šåˆ¶exå‘½ä»¤
    (evil-ex-define-cmd "q" 'kill-this-buffer)
    ;; (evil-set-leader 'normal (kbd "<SPC>"))



    (general-define-key
     :states '(normal motion)
     "gh" 'beginning-of-line-text
     "gl" 'end-of-line
     ;; "," evil-window-map
     )

    (defmacro lmm/create-translate-key-map(from to)
      "Translate key"
      (declare (indent 1) (debug 1))
      (let ((name (intern (concat "lmm/" from "-to-" to "-map"))))
        `(progn
           (defvar ,name (make-sparse-keymap)
             ,(concat "Translate key " from " -> " to)))))

    (general-create-definer lmm/evil-space-leader-def
      :states '(normal motion)
      :keymaps 'override
      :prefix-command 'lmm/evil-space-leader-def-command
      :prefix-map 'lmm/evil-space-leader-def-map
      :non-normal-prefix "C-SPC"
      :prefix "SPC")
    (lmm/evil-space-leader-def
      "w" evil-window-map
      "," 'switch-to-buffer
      "<" 'switch-to-buffer
      "si" 'imenu
      "ff" 'find-file
      "fb" 'switch-to-buffer
      "fr" 'recentf-open-files
      "fw" 'save-buffer
      "fs" 'save-buffer
      "qq" 'lmm/delete-frame-or-C-x-C-c
      "qs" 'evil-save-and-quit
      "es" 'eval-last-sexp
      "ed" 'eval-defun
      "er" 'eval-region
      "eb" 'eval-buffer
      "ep" 'eval-print-last-sexp
      "bk" 'kill-current-buffer
      "j" 'evil-avy-goto-char-timer
      "SPC" 'execute-extended-command
      ":" 'eval-expression)
    (defhydra hydra-Ctrl-quick-key(:foreign-keys warn
                                                 :hint nil)
      ("d" evil-scroll-down)
      ("u" evil-scroll-up)
      ("f" evil-scroll-page-down)
      ("b" evil-scroll-page-up)
      ("j" evil-next-line)
      ("k" evil-previous-line)
      ("q" nil "Quit"))

    (evil-define-key '(normal motion) 'global
          ;; "f" #'evil-avy-goto-char-timer
          ;; "F" #'evil-avy-goto-word-1
          "q" #'evil-execute-macro
          "Q" #'evil-record-macro
          "'" #'evil-goto-mark
          "`" #'evil-goto-mark-line
          "U" #'evil-redo
          "t" #'repeat
          )

      (defvar lmm/goto-next-object-map (make-sparse-keymap))
      (defvar lmm/goto-preview-object-map (make-sparse-keymap))
      (general-define-key
       :keymaps 'lmm/goto-preview-object-map
        "SPC" #'evil-collection-unimpaired-insert-newline-above
        "L" #'evil-collection-unimpaired-first-error
        "P" #'evil-collection-unimpaired-paste-above
        "Q" #'evil-collection-unimpaired-first-error
        "b" #'evil-prev-buffer
        "e" #'evil-collection-unimpaired-move-text-up
        "l" #'evil-collection-unimpaired-previous-error
        "n" #'evil-collection-unimpaired-previous-SCM-conflict-marker
        "p" #'evil-collection-unimpaired-paste-above
        "q" #'evil-collection-unimpaired-previous-error
        "6" #'evil-collection-unimpaired-b64-encode
        "u" #'evil-collection-unimpaired-url-encode
        "'" #'evil-previous-mark-line
        "(" #'evil-previous-open-paren
        "[" #'evil-backward-section-begin
        "]" #'evil-backward-section-end
        "`" #'evil-previous-mark
        "s" #'evil-prev-flyspell-error
        "{" #'evil-previous-open-brace
        "f" #'beginning-of-defun)

      (general-define-key
       :keymaps 'lmm/goto-next-object-map
        "SPC" #'evil-collection-unimpaired-insert-newline-below
        "L" #'evil-collection-unimpaired-last-error
        "Q" #'evil-collection-unimpaired-last-error
        "b" #'evil-next-buffer
        "l" #'evil-collection-unimpaired-next-error
        "e" #'evil-collection-unimpaired-move-text-down
        "n" #'evil-collection-unimpaired-next-SCM-conflict-marker
        "P" #'evil-collection-unimpaired-paste-below
        "p" #'evil-collection-unimpaired-paste-below
        "q" #'evil-collection-unimpaired-next-error
        "6" #'evil-collection-unimpaired-b64-decode
        "u" #'evil-collection-unimpaired-url-decode
        "'" #'evil-next-mark-line
        ")" #'evil-next-close-paren
        "[" #'evil-forward-section-end
        "]" #'evil-forward-section-begin
        "`" #'evil-next-mark
        "s" #'evil-next-flyspell-error
        "}" #'evil-next-close-brace
        "f" #'end-of-defun)
      (evil-define-key '(normal motion visual) 'global
      ";" lmm/goto-next-object-map
      "," lmm/goto-preview-object-map)

    :bind
    (:map evil-insert-state-map
          ("C-a" . beginning-of-visual-line)
          ("C-e" . end-of-visual-line)
          ("C-h" . evil-delete-backward-char)
          ("C-d" . evil-delete-char)
          ("C-k" . kill-line)
          ;; ("C-p" . previous-line)
          ;; ("C-n" . next-line)
          ("C-g" . evil-normal-state)
          :map evil-window-map
          ("d" . kill-buffer-and-window)
          ("x" . kill-current-buffer)
          ("n" . evil-next-buffer)
          ("p" . evil-prev-buffer)
          ("w" . evil-window-mru)
          ("W" . evil-window-next)
          ("," . evil-switch-to-windows-last-buffer)))
#+END_SRC

** COMMENT Evil-Escape
#+BEGIN_SRC emacs-lisp
  (use-package evil-escape
    :disabled
    :no-require t
    :straight t
    :hook
    (evil-mode-hook . evil-escape-mode)
    :init
    (setq-default evil-escape-key-sequence "jk")
    ;; åªåœ¨æŒ‡å®šä¸»æ¨¡å¼å½“ä¸­å¯ç”¨
    ;; (setq evil-escape-enable-only-for-major-modes '(prog-mode
    ;;                                                 org-mode
    ;;                                                 org-src-mode
    ;;                                                 emacs-lisp-mode
    ;;                                                 ))
    ;; åªåœ¨æŒ‡å®šä¸»æ¨¡å¼å½“ä¸­ç¦ç”¨
    (setq-default evil-escape-excluded-major-modes '(help-mode
                                                     ibuffer-mode
                                                     dired-mode
                                                     Info-mode
                                                     undo-tree-mode))

    (add-hook 'magit-mode-hook (lambda ()
                                 (setq-local evil-escape-inhibit t)))
    ;; å½“è¡¨ä¸­çš„å‡½æ•°è¿”å›é nil æ—¶ç¦æ­¢ä½¿ç”¨
    (setq evil-escape-inhibit-functions '(evil-visual-state-p))
    :diminish evil-escape-mode
    )
#+END_SRC

** Other Evil Plugins
#+BEGIN_SRC emacs-lisp
  ;; æ›´å¤šçš„æŒ‰é”®ç»‘å®š
  (use-package evil-collection
    :straight t
    :config
    (dolist (mode '(corfu vterm))
      (delq mode evil-collection-mode-list))
    :hook
    (evil-mode-hook . evil-collection-init))

  ;; æ³¨é‡Š
  (use-package evil-nerd-commenter
    :straight t
    :after evil
    ;; :bind
    ;; (:map lmm/leader-comma-map
    ;;       (";" . evilnc-comment-operator)
    ;;       ("l" . evilnc-comment-or-uncomment-lines))
    :config
    (defun lmm/comment-dwim-auto-insert (arg)
      "comment line or mark region, if evil normal state auto toggle insert state"
      (interactive "*P")
      (comment-dwim arg)
      (if evil-normal-state-minor-mode
          (evil-append 0)))

    (general-define-key
     :states 'normal
     "M-;" 'comment-dwim)

    (general-define-key
     :states 'normal
     "gc" (general-key-dispatch 'evilnc-comment-operator
            "l" 'evilnc-comment-or-uncomment-lines)))

  ;; æ‹¬å·ä¿®æ”¹
  (use-package evil-surround
    :straight t
    :hook
    (org-mode-hook . evil-surround-mode)
    (prog-mode-hook . evil-surround-mode))

  ;; æ’¤é”€æ ‘
  (use-package undo-tree
    :disabled
    ;; :straight t
    ;; :hook
    ;; (evil-mode-hook . global-undo-tree-mode)
    :bind
    (:map undo-tree-visualizer-mode-map
          ("l" . undo-tree-visualize-switch-branch-right)
          ("h" . undo-tree-visualize-switch-branch-left)
          :map undo-tree-map
          ("C-/" . evil-undo)))
  ;; C-x u ä¼šå‡ºæ¥ä¸€ä¸ªæ’¤é”€æ ‘å¯ä¾›é€‰æ‹©ä»¥å‰çš„ä¸€äº›ç¼–è¾‘çŠ¶æ€
  ;; å¯æŒ‰ d è¿›è¡Œ diff å¯¹æ¯”

  ;; äº¤æ¢æ ‡è®°åŒºåŸŸ
  (use-package evil-exchange
    :straight t
    :after evil
    :config
    (general-define-key
     :states 'normal
     "gx" 'evil-exchange
     "gX" 'evil-exchange-cancel))

  ;; å‚æ•°è·³è½¬ä¸ä¿®æ”¹
  (use-package evil-args
    :straight t
    :after evil
    :bind
    (:map evil-inner-text-objects-map
          ("a" . evil-inner-arg)
          :map evil-outer-text-objects-map
          ("a" . evil-outer-arg)
          :map evil-normal-state-map
          (",a" . evil-backward-arg)
          (";a" . evil-forward-arg)
          :map evil-motion-state-map
          (",a" . evil-backward-arg)
          (";a" . evil-forward-arg)
          )
    )

  ;; å¿«é€Ÿè·³è½¬
  (use-package evil-snipe
    :straight t
    :hook
    (evil-mode-hook . evil-snipe-mode)
    :init
    (setq evil-snipe-scope 'visible
          evil-snipe-repeat-scope 'nil
          evil-snipe-smart-case t)
    :config
    (evil-define-key '(normal motion visual) 'global
      "f" #'evil-snipe-f
      "F" #'evil-snipe-F
      "s" #'evil-snipe-s
      "S" #'evil-snipe-S)
    (set-face-attribute 'evil-snipe-matches-face nil
                        :background nil
                        :foreground "red"
                        :weight 'normal
                        :underline '(:color "red" :position 0))
    (set-face-attribute 'evil-snipe-first-match-face nil
                        :background nil
                        :foreground nil
                        :underline nil
                        :weight 'normal))

  (use-package evil-embrace
    :straight t
    :after evil-snipe
    :init
    (setq evil-embrace-show-help-p nil)
    :config
    (evil-embrace-enable-evil-surround-integration))
  #+END_SRC

** Other Evil EditUtils
#+BEGIN_SRC emacs-lisp
  (use-package evil
    :config
    ;; åˆ é™¤å½“å‰è¡Œå…‰æ ‡å‰æ‰€æœ‰ç©ºæ ¼
    (general-define-key
     :keymaps 'evil-outer-text-objects-map
     "SPC" (lambda ()(interactive) (cycle-spacing 0)))
    ;; åˆ é™¤å½“å‰è¡Œå…‰æ ‡å‰ç©ºæ ¼ï¼Œä¿ç•™ä¸€ä¸ª
    (general-define-key
     :keymaps 'evil-inner-text-objects-map
     "SPC" 'cycle-spacing)

    (evil-define-command evil-vsplit-next-buffer (&optional count)
      "Vsplits the window and goes to the COUNT-th next buffer in the buffer list."
      :repeat nil
      (interactive "p")
      (evil-window-vsplit)
      (evil-next-buffer count))

    (evil-define-command evil-vsplit-prev-buffer (&optional count)
      "Vsplits window and goes to the COUNT-th prev buffer in the buffer list."
      :repeat nil
      (interactive "p")
      (evil-window-vsplit)
      (evil-prev-buffer count))

    (defun lmm/vsplit-other-buffer (&optional arg)
      "VSplit this window"
      (interactive "P")
      (split-window-horizontally)
      (let ((target-window (next-window)))
        (set-window-buffer target-window (other-buffer))
        (unless arg
          (select-window target-window))))

    (defun lmm/split-other-buffer (&optional arg)
      "Split this window"
      (interactive "P")
      (split-window-vertically)
      (let ((target-window (next-window)))
        (set-window-buffer target-window (other-buffer))
        (unless arg
          (select-window target-window))))

    (general-define-key
     :keymaps 'evil-window-map
     "s" 'lmm/split-other-buffer
     "v" 'lmm/vsplit-other-buffer)

    (evil-define-text-object evil-inner-line (count &optional beg end type)
      "Select in current visual line, not \n"
      (let ((begin (save-excursion (beginning-of-line-text) (point)))
            (end (save-excursion (end-of-visual-line) (point))))
        (evil-range begin end)))

    (evil-define-text-object evil-a-line (count &optional beg end type)
      "Select in current line, not \n"
      (let ((begin (save-excursion (beginning-of-line-text) (point)))
            (end (save-excursion (end-of-line) (point))))
        (evil-range begin end)))

    (define-key evil-inner-text-objects-map "l" 'evil-inner-line)
    (define-key evil-outer-text-objects-map "l" 'evil-a-line)

    (evil-define-motion evil-forward-in-word-begin(count &optional bigword)
      "Jump to next word"
      :type excessive
      (forward-to-word (or count 1)))

    ;; (evil-define-key '(normal motion) 'global
    ;;   "w" 'evil-forward-in-word-begin)

    (evil-define-motion evil-backward-in-word-begin(count &optional bigword)
      "Backward in word begin"
      :type exclusive
      (backward-word (or count 1)))

    ;; (evil-define-key '(normal motion) 'global
    ;;   "r" 'evil-backward-in-word-begin)
    )
#+END_SRC

* WINDOW AND BUFFER AND FRAME
** Utils Functions
#+BEGIN_SRC emacs-lisp
  (defun lmm/kill-current-buffer-and-window ()
    "kill current buffer and window, if just one window, kill current buffer"
    (interactive)
    (if (and (window-full-width-p) (window-full-height-p))
        (kill-current-buffer)
      (kill-buffer-and-window)))

  (use-package evil
    :bind
    (:map evil-window-map
          ("D" . kill-this-buffer)
          ("d" . lmm/kill-current-buffer-and-window)))
#+END_SRC

** Window Split Config
#+BEGIN_SRC emacs-lisp
  ;; çª—å£å¸ƒå±€å†å²åˆ‡æ¢
  (use-package winner
    :after evil
    :config
    (winner-mode)
    (define-key evil-window-map "u" 'winner-undo)
    (define-key evil-window-map "U" 'winner-redo))

  ;; å°½å¯èƒ½é‡ç”¨ç°æœ‰buffer
  ;; (customize-set-variable 'display-buffer-base-action
  ;;                         '((display-buffer-reuse-window display-buffer-same-window)
  ;;                           (reusable-frames . t)))
  ;; (customize-set-variable 'even-window-sizes nil)

  ;; (add-to-list
  ;;  'display-buffer-alist
  ;;  '("^\\*\\(Help\\|info\\|cargo.*\\)\\*$" (display-buffer-at-bottom) (window-height . 0.4)))
  (add-to-list
   'display-buffer-alist
   '("^\\*.*\\*$" (display-buffer-at-bottom) (window-height . 0.4)))
  (add-to-list
   'display-buffer-alist
   '("^\\*Org Src.*\\*$" (display-buffer-use-some-window)))
#+END_SRC

** Window Jump Config
#+BEGIN_SRC emacs-lisp
  (use-package ace-window
    :straight t
    :custom
    (aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l))
    (aw-background nil)
    :hook
    (after-init-hook . ace-window-display-mode)
    :config
    (general-define-key
     :keymaps 'evil-window-map
     "w" 'ace-window))
#+END_SRC

** Buffers Config
#+BEGIN_SRC emacs-lisp
  (use-package fullframe
    :disabled
    :no-require t
    :after
    (fullframe ibuffer ibuffer-quit))
  (use-package ibuffer
    :init
    (setq ibuffer-formats
          '((mark modified read-only vc-status-mini " "
                  (name 22 22 :left :elide)
                  " "
                  (size-h 9 -1 :right)
                  " "
                  (mode 12 12 :left :elide)
                  " "
                  vc-relative-file)
            (mark modified read-only vc-status-mini " "
                  (name 22 22 :left :elide)
                  " "
                  (size-h 9 -1 :right)
                  " "
                  (mode 14 14 :left :elide)
                  " "
                  (vc-status 12 12 :left)
                  " "
                  vc-relative-file)))

    (setq ibuffer-filter-group-name-face 'font-lock-doc-face)
    :config
    (global-set-key [remap list-buffers] 'ibuffer)
    (define-ibuffer-column size-h
      (:name "Size" :inline t)
      (file-size-human-readable (buffer-size)))
    )
  (use-package ibuffer-vc
    :straight t
    :config
    (defun ibuffer-set-up-preferred-filters ()
      (ibuffer-vc-set-filter-groups-by-vc-root)
      (unless (eq ibuffer-sorting-mode 'filename/process)
        (ibuffer-do-sort-by-filename/process)))

    (add-hook 'ibuffer-hook 'ibuffer-set-up-preferred-filters)

    (setq-default ibuffer-show-empty-filter-groups nil)
    )
#+END_SRC

** COMMENT POPUP WINDOW MANAGER
#+BEGIN_SRC emacs-lisp
  (use-package popwin
    :straight t
    :hook
    (after-init-hook . popwin-mode)
    :config
    (push '("^\\*cargo-run.*\\*$" :regexp t :position bottom) popwin:special-display-config)
    (push '("^\\*cargo-clippy.*\\*$" :regexp t :position bottom) popwin:special-display-config)
    (push '("^\\*Help.*\\*$" :regexp t :position bottom) popwin:special-display-config)
    )
#+END_SRC

** Frame Config
#+BEGIN_SRC emacs-lisp
  (defun lmm/delete-frame-or-C-x-C-c(&optional arg)
    (interactive "P")
      (if (delete-frame-enabled-p)
          (delete-frame)
        (save-buffers-kill-terminal arg)))
#+END_SRC

** COMMENT Auto Save Window Size
è‡ªåŠ¨ä¿å­˜çª—å£å°ºå¯¸
#+BEGIN_SRC emacs-lisp
  (use-package desktop
    :defer t
    :init
    (setq desktop-path (list user-emacs-directory)
          desktop-auto-save-timeout 600)
    :hook
    (window-setup-hook . desktop-save-mode))
#+END_SRC

* WHICH KEY
#+BEGIN_SRC emacs-lisp
  (use-package which-key
    :straight t
    :hook
    (after-init-hook . which-key-mode)
    :diminish which-key-mode
    )
#+END_SRC

* MINIBUFFER
** Minibuffer
#+BEGIN_SRC emacs-lisp
  ;; åœ¨ minibuffer ä¸­æ‰§è¡Œ minibuffer
  (setq enable-recursive-minibuffers t)
  ;; ç¦æ­¢å…‰æ ‡ç§»åŠ¨åˆ°æç¤ºæ–‡æœ¬ä¸Š
  (customize-set-variable 'minibuffer-prompt-properties '(read-only t cursor-intangible t face minibuffer-prompt))

  (defun lmm/evil-minibuffer-insert()
    "Minibuffer evil insert state"
    (setq-local evil-echo-state nil)
    (evil-insert 1))

  (remove-hook 'minibuffer-setup-hook 'evil-collection-minibuffer-insert)
  ;; (add-hook 'minibuffer-setup-hook 'lmm/evil-minibuffer-insert)


  (use-package evil
    :config
    (evil-define-key* 'normal minibuffer-local-map
      (kbd "ESC") 'minibuffer-keyboard-quit
      (kbd "q") 'minibuffer-keyboard-quit
      (kbd "C-f") 'scroll-up-command
      (kbd "C-b") 'scroll-down-command
      (kbd "C-v") 'scroll-up-command
      (kbd "C-d") 'scroll-up-command
      (kbd "C-u") 'scroll-down-command
      (kbd "C-p") #'previous-history-element
      (kbd "C-n") #'next-history-element
      (kbd "j") 'next-line
      (kbd "k") 'previous-line
      (kbd "J") 'next-history-element
      (kbd "K") 'previous-history-element
      (kbd "RET") 'exit-minibuffer
      (kbd "g") 'minibuffer-beginning-of-buffer
      (kbd "G") 'end-of-buffer
      (kbd "o") 'embark-act
      (kbd ",") #'previous-history-element
      (kbd ".") #'next-history-element
      )
    (evil-define-key* 'insert minibuffer-local-map
      (kbd "ESC") #'minibuffer-keyboard-quit
      (kbd "C-g") #'minibuffer-keyboard-quit
      (kbd "C-v") #'scroll-up-command
      (kbd "C-n") #'next-line
      (kbd "C-p") #'previous-line
      (kbd "C-k") #'kill-line
      (kbd "RET") #'exit-minibuffer
      )

    (general-define-key
     :states 'insert
     :keymaps 'minibuffer-local-map
     "j" (general-key-dispatch 'self-insert-command
           :timeout 0.1
           "k" 'evil-normal-state
           ";" 'minibuffer-keyboard-quit)))
#+END_SRC

** Vertico -- å‘½ä»¤å®Œæˆ
#+BEGIN_SRC emacs-lisp
  ;; minibufferå‘½ä»¤è®°å½•æ•°é‡
  (setq-default history-length 1000)
  ;;å‘½ä»¤å†å²
  (use-package savehist
    :hook
    (after-init-hook . savehist-mode))
  (use-package vertico  ;;å‘½ä»¤è¡¥å…¨
    :straight (:files (:defaults "extensions/*"))
    :init
    (setq vertico-count 15)
    :hook
    (after-init-hook . vertico-mode)
    (minibuffer-setup-hook . vertico-repeat-save)
    :bind
    (:map vertico-map
          ("C-w" . backward-kill-word)
          ("C-r" . consult-history)
          ("C-<return>" . vertico-exit-input)
          ("C-h" . vertico-directory-delete-char)
          ("C-w" . vertico-directory-delete-word)
          ("M-<backspace>" . vertico-directory-up)
          ("M-h" . vertico-directory-up)
          ("C-<backspace>" . backward-kill-word)
          ("C-u" . evil-delete-back-to-indentation))
    :config
    (lmm/evil-space-leader-def
      "X" 'vertico-repeat))
  (use-package orderless  ;;æœç´¢æ’åº
    :straight t
    :after vertico
    :init
    (setq completion-styles '(orderless)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion))))
    :config
    (set-face-background 'orderless-match-face-0 nil)
    (set-face-background 'orderless-match-face-1 nil)
    (set-face-background 'orderless-match-face-2 nil)
    (set-face-background 'orderless-match-face-3 nil)

    ;; æ’é™¤é¡¹
    ;; !word
    (defun lmm/orderless-dispatch-without-if-bang (pattern _index _total)
      (cond
       ((equal "!" pattern)
        '(orderless-literal . ""))
       ((string-prefix-p "!" pattern)
        `(orderless-without-literal . ,(substring pattern 1)))))

    ;; æ•£åˆ—
    ;; word~
    ;; thws-os-wor-isd
    (defun lmm/orderless-dispatch-flex (pattern _index _total)
      (when (string-suffix-p "~" pattern)
        `(orderless-flex . ,(substring pattern 0 -1))))

    ;; å‰ç¼€
    ;; `word
    ;; wordsub
    (defun lmm/orderless-dispatch-prefixes(pattern _index _total)
      (when (string-prefix-p "`" pattern)
        `(orderless-prefixes . ,(substring pattern 1))))

    ;; (setq orderless-style-dispatchers '(lmm/orderless-dispatch-without-if-bang
    ;;                                     lmm/orderless-dispatch-flex))
    )
  (use-package marginalia  ;;å‘½ä»¤æ³¨é‡Š
    :straight t
    :after vertico
    :config
    (marginalia-mode)
    )
#+END_SRC

** Consult -- æœç´¢å®Œæˆ
#+BEGIN_SRC emacs-lisp
  (use-package consult
    :straight t
    :after vertico
    :config
    (global-set-key (kbd "M-Y") 'consult-yank-from-kill-ring)
    (global-set-key [remap switch-to-buffer] 'consult-buffer)
    (global-set-key [remap switch-to-buffer-other-window] 'consult-buffer-other-window)
    (global-set-key [remap switch-to-buffer-other-frame] 'consult-buffer-other-frame)
    (global-set-key [remap goto-line] 'consult-goto-line)
    (consult-customize
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-recent-file consult--source-project-recent-file consult--source-bookmark
     :preview-key (kbd "M-."))
    (advice-add #'completing-read-multiple
                :override #'consult-completing-read-multiple)
    ;; æ›¿æ¢ç³»ç»Ÿå®Œæˆ
    (setq completion-in-region-function
          (lambda (&rest args)
            (apply (if vertico-mode
                       #'consult-completion-in-region
                     #'completion--in-region)
                   args)))

    (defun lmm/consult-symbol-at-point (&optional n)
      "get symbol at current point, search geted symbol at consult-line"
      (interactive)
      (consult-line (thing-at-point 'symbol)))
    (defun lmm/consult-symbol-at-point-multi (&optional n)
      "get symbol at current point, search geted symbol at consult-line-multi"
      (interactive)
      (consult-line-multi nil (thing-at-point 'symbol)))

    (defun lmm/consult-word-at-point (&optional n)
      "get word at current point, search geted word at consult-line"
      (interactive)
      (consult-line (thing-at-point 'word)))
    (defun lmm/consult-word-at-point-multi (&optional n)
      "get word at current point, search geted word at consult-line-multi"
      (interactive)
      (consult-line-multi nil (thing-at-point 'word)))

    (defun lmm/consult-number-at-point (&optional n)
      "get number at current point, search geted number at consult-line"
      (interactive)
      (consult-line (if-let ((n (number-at-point)))
                        (number-to-string n)
                      nil)))
    (defun lmm/consult-number-at-point-multi (&optional n)
      "get number at current point, search geted number at consult-line-multi"
      (interactive)
      (consult-line-multi nil (if-let ((n (number-at-point)))
                                  (number-to-string n)
                                nil)))

    (lmm/evil-space-leader-def
      "sb" 'consult-line
      "sB" 'consult-line-multi
      "s.s" 'lmm/consult-symbol-at-point
      "s.S" 'lmm/consult-symbol-at-point-multi
      "s.w" 'lmm/consult-word-at-point
      "s.W" 'lmm/consult-word-at-point-multi
      "s.n" 'lmm/consult-number-at-point
      "s.N" 'lmm/consult-number-at-point-multi
      "si" (lambda ()(interactive) (if (eq major-mode 'org-mode)(consult-org-heading)(consult-imenu)))
      "sI" 'consult-imenu-multi
      "fr" 'consult-recent-file
      )
    )
  (use-package consult-flycheck
    :straight t
    :after consult
    )
#+END_SRC

** Embark -- ä¸Šä¸‹æ–‡èœå•
#+BEGIN_SRC emacs-lisp
  (use-package embark   ;;
    :straight t
    :after vertico
    :init
    :bind
    (("C-;". embark-act)
     :map vertico-map
          ("C-." . (lambda ()(interactive)
                     (let ((embark-quit-after-action nil))
                                             (embark-act))))
          ;; å¯¼å‡ºå½“å‰åˆ—è¡¨åˆ°é¢å¤–bufferï¼Œç„¶åæ‰§è¡Œå„ç§æ“ä½œ
          ("C-;" . embark-act)
          ("C-c C-o" . embark-export)
          )
    :config
    ;; embark menu with which key
    (defun embark-which-key-indicator ()
      "An embark indicator that displays keymaps using which-key.
  The which-key help message will show the type and value of the
  current target followed by an ellipsis if there are further
  targets."
      (lambda (&optional keymap targets prefix)
        (if (null keymap)
            (which-key--hide-popup-ignore-command)
          (which-key--show-keymap
           (if (eq (plist-get (car targets) :type) 'embark-become)
               "Become"
             (format "Act on %s '%s'%s"
                     (plist-get (car targets) :type)
                     (embark--truncate-target (plist-get (car targets) :target))
                     (if (cdr targets) "Â¡Â­" "")))
           (if prefix
               (pcase (lookup-key keymap prefix 'accept-default)
                 ((and (pred keymapp) km) km)
                 (_ (key-binding prefix 'accept-default)))
             keymap)
           nil nil t (lambda (binding)
                       (not (string-suffix-p "-argument" (cdr binding))))))))

    (setq embark-indicators
          '(embark-which-key-indicator
            embark-highlight-indicator
            embark-isearch-highlight-indicator))

    (defun embark-hide-which-key-indicator (fn &rest args)
      "Hide the which-key indicator immediately when using the completing-read prompter."
      (which-key--hide-popup-ignore-command)
      (let ((embark-indicators
             (remq #'embark-which-key-indicator embark-indicators)))
        (apply fn args)))

    (advice-add #'embark-completing-read-prompter
                :around #'embark-hide-which-key-indicator)
    )
  (use-package embark-consult
    :straight t
    :after (embark consult)
    :demand t
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+END_SRC

* ORG MODE CONFIG
#+BEGIN_SRC emacs-lisp
  (use-package org
    :straight (:type built-in)
    :commands org-mode
    :init
    (setq org-src-window-setup 'current-window
          org-src-tab-acts-natively nil
          )

    :config
    (set-face-attribute 'org-block nil
                        :foreground nil)
    (set-face-attribute 'org-block-begin-line nil
                        :inherit nil
                        :background nil
                        :foreground "cyan"
                        :weight 'bold)
    )
  (use-package org-roam
    :straight t
    :init
    (setq org-roam-directory "~/Notes/org-roam")
    :commands org-roma)

  (use-package tempo
    :config
    (require 'org-tempo)
    (tempo-define-template "org-src"
                           '("#+BEGIN_SRC " p '> n nil "#+END_SRC" >)))

  (use-package org-superstar
    :straight t
    :hook
    (org-mode-hook . org-superstar-mode))

  (use-package evil-org
    :straight t
    :hook
    (org-mode-hook . evil-org-mode))
#+END_SRC

* EDIT SETTINGS
** Newline
#+BEGIN_SRC emacs-lisp
  (defun lmm/newline()
    (interactive)
    (if (nth 4 (syntax-ppss))
        (call-interactively 'comment-indent-new-line)
      (call-interactively 'newline)))

  (global-set-key (kbd "RET") #'lmm/newline)
#+END_SRC

** Repeat -- é‡å¤å‘½ä»¤
#+BEGIN_SRC emacs-lisp
  (use-package repeat
    :commands repeat)
#+END_SRC

** Search -- anzu
#+BEGIN_SRC emacs-lisp
  (use-package anzu
    :straight t
    :hook
    (after-init-hook . global-anzu-mode))

  (use-package color-rg
    :straight (:host github
                     :repo "manateelazycat/color-rg"
                     :branch "master")
    :commands color-rg-search-input
    )
#+END_SRC

*** Evil-auzu
#+BEGIN_SRC emacs-lisp
  (use-package evil-anzu
    :straight t
    :after evil anzu
    )
#+END_SRC

** Keyboard Input -- ä¸­æ–‡è¾“å…¥
#+BEGIN_SRC emacs-lisp
  (use-package pyim
    :straight t
    :commands toggle-input-method
    :init
    (setq default-input-method "pyim")
    (setq pyim-default-scheme 'quanpin)
    (setq pyim-punctuation-translate-p '(no auto yes))
    :config
    ;; (setq pyim-dicts
    ;;       `((:name "Greatdict" :file ,(concat user-emacs-directory "pyim/dicts/pyim-greatdict.pyim"))))

  ;;   (defvar lmmv/pyim-ch-input-state t
  ;;     "æ’å…¥æ¨¡å¼ä¸‹ä¸­æ–‡è¾“å…¥çŠ¶æ€")

  ;;   (defun lmm/pyim-evil-insert-to-normal-state()
  ;;     (interactive)
  ;;     (if lmmv/pyim-ch-input-state
  ;;         (funcall-interactively 'pyim-deactivate))
  ;;     (funcall-interactively 'evil-normal-state))

  ;;   (defun lmm/pyim-evil-normal-to-insert-state()
  ;;     (interactive)
  ;;     (if lmmv/pyim-ch-input-state
  ;;         (funcall-interactively 'pyim-activate)))

    ;; ä»£æ›¿é»˜è®¤
    ;; (custom-set-variables
    ;;  '(pyim-english-input-switch-functions '(pyim-probe-program-mode)))

  (defun pyim-preview-delete-string ()
    "åˆ é™¤å·²ç»æ’å…¥ buffer çš„ preview é¢„è§ˆå­—ç¬¦ä¸²ã€‚"
    (when (and pyim-preview-overlay (overlay-start pyim-preview-overlay))
      (delete-region (overlay-start pyim-preview-overlay)
                     (overlay-end pyim-preview-overlay))))

    (general-define-key
     :keymaps 'pyim-mode-map
     "," 'pyim-previous-page
     "." 'pyim-next-page
     "j" (general-key-dispatch 'pyim-self-insert-command
           :timeout 0.1
           "k" (lambda ()(interactive)
                 (funcall-interactively 'pyim-quit-clear)
                 (funcall-interactively 'evil-normal-state))
           "l" 'toggle-input-method))

  ;;   (general-define-key
  ;;    :keymaps 'pyim-mode-map
  ;;    "," 'pyim-previous-page
  ;;    "." 'pyim-next-page
  ;;    "j" (general-key-dispatch (lambda () (interactive)
  ;;                                (pyim-self-insert-command))
  ;;          :timeout 0.1
  ;;          "k" 'lmm/pyim-evil-insert-to-normal-state
  ;;          "l" (lambda () (interactive)
  ;;                (cond (lmmv/pyim-ch-input-state
  ;;                       (pyim-preview-delete-overlay)
  ;;                       (funcall-interactively 'pyim-quit-clear)
  ;;                       (funcall-interactively 'pyim-deactivate)
  ;;                       (setq-local lmmv/pyim-ch-input-state nil))
  ;;                      (t
  ;;                       (pyim-preview-delete-overlay)
  ;;                       (funcall-interactively 'pyim-quit-clear)
  ;;                       (funcall-interactively 'pyim-activate)
  ;;                       (setq-local lmmv/pyim-ch-input-state t))
  ;;                    ))))
  ;; (general-define-key
  ;;      :states 'insert
  ;;      "j" (general-key-dispatch 'self-insert-command
  ;;            :timeout 0.1
  ;;            "k" 'evil-normal-state
  ;;            "l" (lambda()(interactive)(if (string-equal current-input-method "pyim")
  ;;                                          (progn (funcall-interactively 'pyim-activate)
  ;;                                                 (setq-local lmmv/pyim-ch-input-state t))
  ;;                                        (insert ?j?l)))))

    (let* ((file (concat user-emacs-directory "pyim/dicts/pyim-greatdict.pyim.gz")))
      (if (file-exists-p file)
          (if (featurep 'pyim)
              (pyim-extra-dicts-add-dict
               `(:name "Greatdict"
                       :file ,file
                       :coding utf-8-unix
                       :dict-type pinyin-dict
                       ))
            (message "pyim not install !!!"))
        (message (format "pyim dict file \"%s\" not found !!!" file))))


  ;; (let* ((dictspath (concat user-emacs-directory "pyim/dicts"))
  ;;        (dictfiles (directory-files dictspath)))
  ;;   (if dictfiles
  ;;       ()))
  )

#+END_SRC

** Default Variable -- ç³»ç»Ÿé»˜è®¤å˜é‡
#+BEGIN_SRC emacs-lisp
  (setq-default
   create-lockfiles nil                   ;; åˆ›å»ºé”å®šæ–‡ä»¶ä»¥é˜²æ­¢å…¶ä»–ç”¨æˆ·åŒæ—¶ç¼–è¾‘ , just like #filename
   inhibit-compacting-font-caches t
   bookmark-default-file (expand-file-name ".bookmarks.el" user-emacs-directory)
   buffers-menu-max-size 30
   case-fold-search t
   column-number-mode t
   ediff-split-window-function 'split-window-horizontally
   ediff-window-setup-function 'ediff-setup-windows-plain
   ;; ç¦ç”¨TABä»£æ›¿ç©ºç™½ç¼©è¿›
   indent-tabs-mode nil
   make-backup-files nil
   mouse-yank-at-point t
   save-interprogram-paste-before-kill t
   scroll-preserve-screen-position 'always
   scroll-conservatively 1000
   set-mark-command-repeat-pop t
   tooltip-delay 1.5
   truncate-lines nil
   truncate-partial-width-windows nil
   ;; è¡Œä¸Šä¸‹è¾¹è·
   scroll-margin 0
   ;; åˆ—å·¦å³è¾¹è·
   visual-line-fringe-indicators '(nil right-curly-arrow)
   )
#+END_SRC

** Default Mode -- ç³»ç»Ÿé»˜è®¤æ¨¡å¼
*** è‡ªåŠ¨åŠ è½½æ–‡ä»¶
#+BEGIN_SRC emacs-lisp
  (add-hook 'after-init-hook 'global-auto-revert-mode)
  (setq global-auto-revert-non-file-buffers t
        auto-revert-verbose nil)
  (diminish 'auto-revert-mode)
#+END_SRC

*** é•¿è¡Œæ–‡ä»¶æ€§èƒ½ç¼“è§£
#+BEGIN_SRC emacs-lisp
  (use-package so-long
    :hook
    (after-init-hook . global-so-long-mode))
#+END_SRC

*** é€‰ä¸­æ–‡å­—è¾“å…¥æ›¿æ¢
#+BEGIN_SRC emacs-lisp
  (delete-selection-mode 1)
#+END_SRC

*** å…³é—­è‡ªåŠ¨ç”Ÿäº§çš„ä¿å­˜æ–‡ä»¶
#+BEGIN_SRC emacs-lisp
  (setq auto-save-default nil)
#+END_SRC

** Word Jump
#+BEGIN_SRC emacs-lisp
  (use-package avy
    :straight t
    :after evil
    :init
    (setq avy-timeout-seconds 0.3)
    :config
    (lmm/evil-space-leader-def
      "aml" 'avy-move-line
      "amr" 'avy-move-region
      "acl" 'avy-copy-line
      "acr" 'avy-copy-region
      "aw" 'avy-goto-word-0
      "akl" 'avy-kill-whole-line
      "akr" 'avy-kill-region
      "ayl" 'avy-kill-ring-save-whole-line
      "ayr" 'avy-kill-ring-save-region
      "as" 'avy-isearch
      "ar" 'avy-resume
      "ab" 'avy-pop-mark)
    (defun lmm/avy-goto-word-1-regexp-and-inside-pairs (pairch &optional arg)
      "å¤åˆ¶æŒ‡å®šä½ç½®æ‹¬å·å†…å®¹å¹¶ç²˜è´´"
      (interactive (list (read-char "char: " t)
                         current-prefix-arg))
      (avy-goto-word-1 pairch arg)

      (goto-char (nth 1 (syntax-ppss)))
      (set-mark (save-excursion
                  (forward-char 1)
                  (skip-chars-forward " \t\n")
                  (point)))
      (forward-list)
      (backward-char)
      (skip-chars-backward " \t\n")
      (exchange-point-and-mark)

      (call-interactively 'kill-ring-save)
      (avy-pop-mark)
      (yank))
    (defun lmm/avy-copy-paren-insert()
      "å¤åˆ¶æŒ‡å®šä½ç½®æ‹¬å·å†…å®¹å¹¶ç²˜è´´"
      (interactive)
      (save-excursion
        (avy-goto-char ?\) current-prefix-arg)
        (evil-yank (car (evil-a-paren)) (cadr (evil-a-paren))))
      (evil-paste-before 1)
      )
    ;; TODO
    (defun lmm/avy-copy-paren-insert(char &optional arg)
      (interactive (list (read-char "char: " t)
                         current-prefix-arg))
      (when (or
             (= char ?\()
             (= char ?\))
             (= char ?\[)
             (= char ?\])
             (= char ?\{)
             (= char ?\})
             (= char ?\")
             )
        (let ((region
               (save-excursion
                 (if (cons (avy-goto-char char arg))
                     ()
                   nil
                   )
                 ))))
        )
      )
    )
#+END_SRC

** Goto Last Change
#+BEGIN_SRC emacs-lisp
  (use-package goto-chg
    :straight t
    )
#+END_SRC

** Expand-region
æ™ºèƒ½é€‰æ‹©åŒºåŸŸ
#+BEGIN_SRC emacs-lisp
  (use-package expand-region
    :straight t
    :bind (:map evil-visual-state-map
                ("." . er/expand-region)
                ("C-." . er/contract-region)))
#+END_SRC

** Parenthes Settings
*** Pairs
#+BEGIN_SRC emacs-lisp
  ;; (when (fboundp 'electric-pair-mode)
  ;;   (add-hook 'after-init-hook 'electric-pair-mode))
  (use-package paredit
    :disabled
    :straight t
    :config
    (diminish 'paredit-mode " Par")
    (dolist (binding '("C-<left>" "C-<right>" "C-M-<left>" "C-M-<right>" "M-s" "M-?"))
      (define-key paredit-mode-map (read-kbd-macro binding) nil))
    (paredit-mode)
    )
  (use-package elec-pair
    :hook
    (after-init-hook . electric-pair-mode)
    ;; org-mode ä¸­å­˜åœ¨bugï¼Œæ•…å…³é—­
    (org-mode-hook . (lambda ()(electric-pair-local-mode -1)))
    :config
    )
  (use-package smartparens
    :straight t
    :init
    (setq sp-highlight-wrap-overlay nil
          sp-highlight-pair-overlay nil
          sp-highlight-wrap-tag-overlay nil)
    :hook
    (org-mode-hook . smartparens-mode)
    :bind
    (:map evil-normal-state-map
          (")" . sp-up-sexp)
          ("(" . sp-backward-up-sexp))
    :config
    (require 'smartparens-config))
#+END_SRC

*** Show Paren Mode
å¼€å¯æ‹¬å·é…å¯¹æ˜¾ç¤º
#+BEGIN_SRC emacs-lisp
  (use-package paren
    :hook
    (after-init-hook . show-paren-mode)
    :config
    (setq show-paren-delay 0)
    (set-face-attribute 'show-paren-match nil
                        :underline '(:color "red" :position 0)
                        :background nil
                        :foreground "red"
                        :weight 'bold
                        ))
  ;; (add-hook 'after-init-hook 'show-paren-mode)
  ;; (add-hook 'show-paren-mode-hook (lambda ()
  ;;                                   (define-advice show-paren-function (:around (fn) fix-show-paren-function)
  ;;                                     "Highlight enclosing parens."
  ;;                                     (cond ((looking-at-p "\\s(") (funcall fn))
  ;;                                           (t (save-excursion
  ;;                                                (ignore-errors (backward-up-list))
  ;;                                                (funcall fn)))))
  ;;                                   (custom-set-faces
  ;;                                    `(show-paren-match ((t (:background ,
  ;;                                                            (face-attribute 'default :background)
  ;;                                                            :foreground "red")))))
  ;;                                   ))
#+END_SRC

** COMMENT Symbol-overlay
åŒè¯é«˜äº®æ˜¾ç¤º
#+BEGIN_SRC emacs-lisp
  (use-package symbol-overlay
    :straight t
    :hook
    ((prog-mode-hook html-mode-hook yaml-mode-hook conf-mode-hook) . symbol-overlay-mode)
    :bind
    (:map symbol-overlay-mode-map
          ("M-i" . symbol-overlay-put)
          ("M-I" . symbol-overlay-remove-all)
          ("M-n" . symbol-overlay-jump-next)
          ("M-p" . symbol-overlay-jump-prev)
          )
    )
#+END_SRC

** COMMENT Page Break Lines
é¡µé¢åˆ†å‰²çº¿(C-q C-l)
#+BEGIN_SRC emacs-lisp
  (use-package page-break-lines
    :straight t
    :hook
    (after-init-hook . global-page-break-lines-mode)
    :diminish page-break-lines-mode)
#+END_SRC

** COMMENT Browse Kill Ring
å‰ªè´´æ¿
#+BEGIN_SRC emacs-lisp
  (use-package browse-kill-ring
    :straight t
    :custom
    (browse-kill-ring-separator "\f")
    :bind
    (("M-Y" . browse-kill-ring)
     (:map browse-kill-ring-mode-map
           ("C-g" . browse-kill-ring-quit)
           ("M-n" . browse-kill-ring-forward)
           ("M-p" . browse-kill-ring-previous))
     )
    :config
    (push 'browse-kill-ring-mode page-break-lines-modes)
    )
#+END_SRC

** COMMENT Iedit -- å¤šåŒºåŸŸåŒæ—¶ç¼–è¾‘
#+BEGIN_SRC emacs-lisp
  (use-package iedit
    :straight t
    )
#+END_SRC

** COMMENT Wgrep -- sedäº¤äº’å¼ç¼–è¾‘ç¼“å†²åŒº
#+BEGIN_SRC emacs-lisp
#+END_SRC

** Snippet -- æ¨¡æ¿è¡¥å…¨
#+BEGIN_SRC emacs-lisp
  (use-package yasnippet
    :straight t
    :hook
    (prog-mode-hook . yas-minor-mode)
    (org-mode-hook . yas-minor-mode)
    :config
    (set-face-attribute 'yas-field-highlight-face nil
                        :background nil
                        :underline '(:color "white" :position 0)
                        :inherit nil))

  (use-package yasnippet-snippets
    :straight t
    :after yasnippet)
#+END_SRC

** Multiple Cursors -- å¤šå…‰æ ‡ç¼–è¾‘
#+BEGIN_SRC emacs-lisp
  (use-package multiple-cursors
    :straight t
    :config
    (defhydra hydra-multiple-cursors(:foreign-keys warn
                                                   :hint nil)
      "
   å¢å‡å…‰æ ‡^^        |  æœç´¢æ ‡è®°^^               |  åŒºåŸŸæˆ–æ‰€æœ‰              % 2(mc/num-cursors) cursor%s(if (> (mc/num-cursors) 1) \"s\" \"\")
  ------------------------------------------------------------------
   [_J_]   å‘ä¸‹æ·»åŠ   |  [_V_]   çŸ©å½¢åŒºåŸŸæ ‡è®°ç¼–è¾‘  |  [_a_]   æ ‡è®°å½“å‰æ‰€æœ‰æ ‡è®°
   [_K_]   å‘ä¸Šæ·»åŠ   |  [_;_]   å‘ä¸‹æœç´¢æ ‡è®°åŒºåŸŸ  |  [_r_]   é€‰æ‹©åŒºåŸŸæœç´¢æ ‡è®°
   [_C-j_] å‘ä¸‹è·³è¿‡  |  [_,_]   å‘ä¸Šæœç´¢æ ‡è®°åŒºåŸŸ  |  [_R_]   é€‰æ‹©åŒºåŸŸæ­£åˆ™æœç´¢
   [_C-k_] å‘ä¸Šè·³è¿‡  |  [_s_]   æ ‡è®°å½“å‰ç¬¦å·å‘ä¸‹  |  [_F_]   æ ‡è®°å½“å‰æ‰€æœ‰å‡½æ•°
   [_p_]   åˆ é™¤æœ€ä¸‹  |  [_S_]   æ ‡è®°å½“å‰ç¬¦å·å‘ä¸Š  |  [_._]   æ™ºèƒ½æ ‡è®°æ·»åŠ å…‰æ ‡
   [_n_]   åˆ é™¤æœ€ä¸Š  |  [_i_]   å¯æŒ‰å‰ç¼€æ’å…¥æ•°å­—  |  [_L_]   é€‰æ‹©åŒºåŸŸæ‰€æœ‰è¡Œå°¾
   [_j_]   åŸºç¡€ç§»åŠ¨  |  [_I_]   å¯æŒ‰å‰ç¼€æ’å…¥å­—æ¯  |  [_H_]   é€‰æ‹©åŒºåŸŸæ‰€æœ‰è¡Œé¦–
  "
      ("j" evil-next-line)
      ("k" evil-previous-line)
      ("h" evil-backward-char)
      ("l" evil-forward-char)
      ("w" evil-forward-word-begin)
      ("e" evil-forward-word-end)
      ("b" evil-backward-word-begin)
      ("v" evil-visual-char)
      ("V" set-rectangular-region-anchor)
      ("J" mc/mark-next-lines)
      ("K" mc/mark-previous-lines)
      ("C-j" mc/skip-to-next-like-this)
      ("C-k" mc/skip-to-previous-like-this)
      ("p" mc/unmark-next-like-this)
      ("n" mc/unmark-previous-like-this)
      ("a" mc/mark-all-like-this)
      ("r" mc/mark-all-in-region)
      ("R" mc/mark-all-in-region-regexp)
      ("F" mc/mark-all-like-this-in-defun)
      ("." mc/mark-all-dwim)
      (";" mc/mark-next-like-this)
      ("," mc/mark-previous-like-this)
      ("s" mc/mark-next-like-this-symbol)
      ("S" mc/mark-previous-like-this-symbol)
      ("L" mc/edit-ends-of-lines)
      ("H" mc/edit-beginnings-of-lines)
      ("i" mc/insert-numbers)
      ("I" mc/insert-letters)
      ("C-g" mc/keyboard-quit "mc/keyboard-quit")
      ("q" nil "Quit"))
    (lmm/evil-space-leader-def
      "mc" 'hydra-multiple-cursors/body))

  ;; (setq mc/cmds-to-run-once
  ;;       '(
  ;;         hydra-multiple-cursors/body
  ;;         hydra-multiple-cursors/evil-next-line
  ;;         hydra-multiple-cursors/evil-previous-line
  ;;         hydra-multiple-cursors/evil-backward-char
  ;;         hydra-multiple-cursors/evil-forward-char
  ;;         hydra-multiple-cursors/evil-forward-word-begin
  ;;         hydra-multiple-cursors/evil-forward-word-end
  ;;         hydra-multiple-cursors/evil-backward-word-begin
  ;;         hydra-multiple-cursors/evil-visual-char
  ;;         hydra-multiple-cursors/set-rectangular-region-anchor
  ;;         hydra-multiple-cursors/mc/mark-next-lines
  ;;         hydra-multiple-cursors/mc/mark-previous-lines
  ;;         hydra-multiple-cursors/mc/skip-to-next-like-this
  ;;         hydra-multiple-cursors/mc/skip-to-previous-like-this
  ;;         hydra-multiple-cursors/mc/unmark-next-like-this
  ;;         hydra-multiple-cursors/mc/unmark-previous-like-this
  ;;         hydra-multiple-cursors/mc/mark-all-like-this
  ;;         hydra-multiple-cursors/mc/mark-all-in-region
  ;;         hydra-multiple-cursors/mc/mark-all-in-region-regexp
  ;;         hydra-multiple-cursors/mc/mark-all-like-this-in-defun
  ;;         hydra-multiple-cursors/mc/mark-all-dwim
  ;;         hydra-multiple-cursors/mc/mark-next-like-this
  ;;         hydra-multiple-cursors/mc/mark-previous-like-this
  ;;         hydra-multiple-cursors/mc/mark-next-like-this-symbol
  ;;         hydra-multiple-cursors/mc/mark-previous-like-this-symbol
  ;;         hydra-multiple-cursors/mc/edit-ends-of-lines
  ;;         hydra-multiple-cursors/mc/edit-beginnings-of-lines
  ;;         hydra-multiple-cursors/mc/insert-numbers
  ;;         hydra-multiple-cursors/mc/insert-letters
  ;;         hydra-multiple-cursors/mc/keyboard-quit
  ;;         hydra-multiple-cursors/nil))
#+END_SRC

** Better Jump
#+BEGIN_SRC emacs-lisp
  (use-package better-jumper
    :straight t
    :hook
    (after-init-hook . better-jumper-mode)
    :config
    (evil-define-key '(normal motion visual) 'global
      "\C-o" #'better-jumper-jump-backward
      "\C-i" #'better-jumper-jump-forward))
#+END_SRC

* LANG CONFIG
** Complete Config
*** Company Install
#+BEGIN_SRC emacs-lisp
  (use-package company
    :disabled
    :no-require t
    :straight t
    :hook
    (after-init-hook . global-company-mode)
    :init
    (setq tab-always-indent 'complete)
    :config
    (dolist (backend '(company-eclim company-semantic))
      (delq backend company-backends))
    (define-key company-active-map (kbd "C-n") 'company-select-next)
    (define-key company-active-map (kbd "C-p") 'company-select-previous)
    (define-key company-active-map (kbd "C-h") nil)
    ;; (define-key company-active-map (kbd "C-g") 'company-above)
    (define-key company-active-map (kbd "C-i") 'company-complete-common)
    (define-key company-active-map (kbd "C-v") 'company-next-page)
    (define-key company-active-map (kbd "M-v") 'company-previous-page)
    (define-key company-active-map (kbd "C-w") nil)
    (define-key company-active-map (kbd "M-<" ) 'company-select-first)
    (define-key company-active-map (kbd "M->" ) 'company-select-last)
    (add-to-list 'completion-styles 'initials t)
    (setq-default company-dabbrev-other-buffers 'all
                  company-tooltip-align-annotations t
                  company-idle-delay 0
                  company-show-numbers nil
                  company-require-match nil
                  company-dabbrev-ignore-case nil
                  company-dabbrev-downcase nil
                  company-tooltip-maximum-width 80
                  company-tooltip-minimum-width 50)
    ;; ä¼˜å…ˆè€ƒè™‘åŒ¹é…å‰ç¼€çš„å€™é€‰è€…
    (setq company-transformers '(company-sort-prefer-same-case-prefix
                                 company-sort-by-occurrence))
    )
#+END_SRC

*** Corfu -- other completion tool
**** Install
#+BEGIN_SRC emacs-lisp
  (use-package corfu
    :straight (:files (:defaults "extensions/*"))
    :init
    ;; è‡ªåŠ¨è§¦å‘è¡¥å…¨
    (setq corfu-auto t
          ;; è¡¥å…¨é¢„è§ˆ
          corfu-preview-current nil

          ;; è¡¥å…¨å€™é€‰é¢„é€‰
          ;; corfu-preselect-first nil
          ;; ç¦ç”¨minibufferæ–‡æ¡£æ˜¾ç¤º
          corfu-echo-documentation nil
          ;; æ»šåŠ¨è¾¹è·
          ;; corfu-scroll-margin 2
          corfu-min-width 80
          corfu-max-width corfu-min-width
          corfu-count 15
          corfu-auto-delay 0.3
          corfu-right-margin-width 1.0
          )
    :hook
    (after-init-hook . global-corfu-mode)
    (corfu-mode-hook . corfu-history-mode)
    :bind
    (:map corfu-map
          ("C-n" . corfu-next)
          ("C-p" . corfu-previous)
          ("M-<" . corfu-first)
          ("M->" . corfu-last)
          ("C-v" . corfu-scroll-up)
          ("M-v" . corfu-scroll-down)
          ("C-'" . corfu-quick-jump)
          ("C-." . corfu-quick-insert)
          ("C-," . corfu-quick-complete)
          ("C-i" . corfu-complete)
          ("M-h" . corfu-info-documentation)
          ("<tab>" . corfu-insert-separator)
          ("C-SPC" . corfu-insert-separator)
          ("C-g" . corfu-quit))
    :config
    ;; insertæ¨¡å¼ä¸‹æŒ‰é”®å¤±æ•ˆï¼Œéœ€æ­¤è®¾ç½®
    (general-add-advice '(corfu--setup corfu--teardown) :after 'evil-normalize-keymaps)
    (evil-make-overriding-map corfu-map)
    (setq lsp-completion-provider :none)
    (defun lmm/lsp-mode-setup-completion()
      (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
            '(orderless)))
    (add-hook 'lsp-completion-mode-hook 'lmm/lsp-mode-setup-completion)


    (set-face-background 'corfu-current "#44475a")
    (set-face-background 'corfu-border "#ffc4cd")
    (set-face-background 'corfu-default "#282a36")
    )
#+END_SRC

**** Corfu Doc
#+BEGIN_SRC emacs-lisp
  (use-package corfu-doc
    :straight t
    :hook
    (corfu-mode-hook . corfu-doc-mode)
    :init
    (setq corfu-doc-auto nil)
    :bind
    (:map corfu-map
    ("M-h" . corfu-doc-toggle)
    ("M-n" . corfu-doc-scroll-up)
    ("M-p" . corfu-doc-scroll-down)))
#+END_SRC

**** cape -- complete backends
#+BEGIN_SRC emacs-lisp
  ;; cape-dabbrev:å½“å‰ç¼“å†²åŒºçš„å®Œæ•´å•è¯
  ;; cape-file:å®Œæ•´çš„æ–‡ä»¶å
  ;; cape-keyword:å®Œæ•´çš„ç¼–ç¨‹è¯­è¨€å…³é”®å­—
  ;; cape-symbol:å®Œæ•´çš„ elisp ç¬¦å·
  ;; cape-abbrev:å®Œæ•´ç¼©å†™(add-global-abbrev, add-mode-abbrev)
  ;; cape-ispell:Ispell è¯å…¸ä¸­çš„å®Œæ•´å•è¯
  ;; cape-dict:å­—å…¸æ–‡ä»¶ä¸­çš„å®Œæ•´å•è¯
  ;; cape-line:ä»å½“å‰ç¼“å†²åŒºå®Œæˆæ•´è¡Œ
  ;; cape-tex:æ¥è‡ª Tex å‘½ä»¤çš„å®Œæ•´ unicode å­—ç¬¦
  ;; cape-sgml:æ¥è‡ª sgml å®Œæ•´çš„ unicode å­—ç¬¦
  ;; cape-rfc1345: unicode
  (use-package cape
    :straight t
    :config
    (dolist (hook '(lisp-mode-hook
                    emacs-lisp-mode-hook
                    lisp-interaction-mode-hook))
      (add-hook hook
              (lambda()
                (setq-local completion-at-point-functions
                            '(cape-symbol cape-file)))))

    (dolist (hook '(rustic-mode-hook))
      (add-hook hook
              (lambda()
                (setq-local completion-at-point-functions
                            (append completion-at-point-functions '(cape-dabbrev cape-file))))))
    (evil-define-key 'insert 'global
      (kbd "C-n") #'cape-dabbrev)
    )
#+END_SRC

**** kind-icon
#+BEGIN_SRC emacs-lisp
  (use-package kind-icon
    :straight t
    :after corfu
    :custom
    (kind-icon-default-face 'corfu-default)
    ;; (kind-icon-blend-frac 0.0)
    (kind-icon-blend-background nil)
    :config
    (custom-set-variables
     '(kind-icon-default-style
       '(:padding 0.3 :stroke 3 :margin 0 :radius 5 :height 0.9 :scale 1.0)))
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+END_SRC

**** COMMENT kind-all-the-icon
#+BEGIN_SRC emacs-lisp
  (defvar kind-all-the-icons--cache nil
    "The cache of styled and padded label (text or icon).
  An alist.")

  (defun kind-all-the-icons-reset-cache ()
    "Remove all cached icons from `kind-all-the-icons-mapping'."
    (interactive)
    (setq kind-all-the-icons--cache nil))

  (defun kind-all-the-icons--set-default-clear-cache (&rest args)
    (kind-all-the-icons-reset-cache)
    (apply #'set-default args))

  (defvar kind-all-the-icons--icons
    `((unknown . ,(all-the-icons-material "find_in_page" :height 0.8 :v-adjust -0.15))
      (text . ,(all-the-icons-faicon "text-width" :height 0.8 :v-adjust -0.02))
      (method . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.02 :face 'all-the-icons-purple))
      (function . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.02 :face 'all-the-icons-purple))
      (fun . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.02 :face 'all-the-icons-purple))
      (constructor . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.02 :face 'all-the-icons-purple))
      (ctor . ,(all-the-icons-faicon "cube" :height 0.8 :v-adjust -0.02 :face 'all-the-icons-purple))
      (field . ,(all-the-icons-octicon "tag" :height 0.85 :v-adjust 0 :face 'all-the-icons-lblue))
      (variable . ,(all-the-icons-octicon "tag" :height 0.85 :v-adjust 0 :face 'all-the-icons-lblue))
      (var . ,(all-the-icons-octicon "tag" :height 0.85 :v-adjust 0 :face 'all-the-icons-lblue))
      (class . ,(all-the-icons-material "settings_input_component" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-orange))
      (interface . ,(all-the-icons-material "share" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-lblue))
      (i/f . ,(all-the-icons-material "share" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-lblue))
      (module . ,(all-the-icons-material "view_module" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-lblue))
      (mod . ,(all-the-icons-material "view_module" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-lblue))
      (property . ,(all-the-icons-faicon "wrench" :height 0.8 :v-adjust -0.02))
      (prop . ,(all-the-icons-faicon "wrench" :height 0.8 :v-adjust -0.02))
      (unit . ,(all-the-icons-material "settings_system_daydream" :height 0.8 :v-adjust -0.15))
      (value . ,(all-the-icons-material "format_align_right" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-lblue))
      (enum . ,(all-the-icons-material "storage" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-orange))
      (keyword . ,(all-the-icons-material "filter_center_focus" :height 0.8 :v-adjust -0.15))
      (k/w . ,(all-the-icons-material "filter_center_focus" :height 0.8 :v-adjust -0.15))
      (snippet . ,(all-the-icons-material "format_align_center" :height 0.8 :v-adjust -0.15))
      (sn . ,(all-the-icons-material "format_align_center" :height 0.8 :v-adjust -0.15))
      (color . ,(all-the-icons-material "palette" :height 0.8 :v-adjust -0.15))
      (file . ,(all-the-icons-faicon "file-o" :height 0.8 :v-adjust -0.02))
      (reference . ,(all-the-icons-material "collections_bookmark" :height 0.8 :v-adjust -0.15))
      (ref . ,(all-the-icons-material "collections_bookmark" :height 0.8 :v-adjust -0.15))
      (folder . ,(all-the-icons-faicon "folder-open" :height 0.8 :v-adjust -0.02))
      (dir . ,(all-the-icons-faicon "folder-open" :height 0.8 :v-adjust -0.02))
      (enum-member . ,(all-the-icons-material "format_align_right" :height 0.8 :v-adjust -0.15))
      (enummember . ,(all-the-icons-material "format_align_right" :height 0.8 :v-adjust -0.15))
      (member . ,(all-the-icons-material "format_align_right" :height 0.8 :v-adjust -0.15))
      (constant . ,(all-the-icons-faicon "square-o" :height 0.8 :v-adjust -0.1))
      (const . ,(all-the-icons-faicon "square-o" :height 0.8 :v-adjust -0.1))
      (struct . ,(all-the-icons-material "settings_input_component" :height 0.8 :v-adjust -0.15 :face 'all-the-icons-orange))
      (event . ,(all-the-icons-octicon "zap" :height 0.8 :v-adjust 0 :face 'all-the-icons-orange))
      (operator . ,(all-the-icons-material "control_point" :height 0.8 :v-adjust -0.15))
      (op . ,(all-the-icons-material "control_point" :height 0.8 :v-adjust -0.15))
      (type-parameter . ,(all-the-icons-faicon "arrows" :height 0.8 :v-adjust -0.02))
      (param . ,(all-the-icons-faicon "arrows" :height 0.8 :v-adjust -0.02))
      (template . ,(all-the-icons-material "format_align_left" :height 0.8 :v-adjust -0.15))
      (t . ,(all-the-icons-material "find_in_page" :height 0.8 :v-adjust -0.15))))


  (defsubst kind-all-the-icons--metadata-get (metadata type-name)
    (or
     (plist-get completion-extra-properties (intern (format ":%s" type-name)))
     (cdr (assq (intern type-name) metadata))))

  (defun kind-all-the-icons-formatted (kind)
    "Format icon kind with all-the-icons"
    (or (alist-get kind kind-all-the-icons--cache)
        (let ((map (assq kind kind-all-the-icons--icons)))
            (let*  ((icon (if map
                              (cdr map)
                            (cdr (assq t kind-all-the-icons--icons))))
                    (half (/ (default-font-width) 2))
                    (pad (propertize " " 'display `(space :width (,half))))
                    (disp (concat pad icon pad)))
              (setf (alist-get kind kind-all-the-icons--cache) disp)
              disp))))

  (defun kind-all-the-icons-margin-formatter (metadata)
    "Return a margin-formatter function which produces kind icons.
  METADATA is the completion metadata supplied by the caller (see
  info node `(elisp)Programmed Completion').  To use, add this
  function to the relevant margin-formatters list."
    (if-let ((kind-func (kind-all-the-icons--metadata-get metadata "company-kind")))
        (lambda (cand)
              (if-let ((kind (funcall kind-func cand)))
                  (kind-all-the-icons-formatted kind)
                (kind-all-the-icons-formatted t))))) ;; as a backup

  (use-package corfu
    :config
    (add-to-list 'corfu-margin-formatters #'kind-all-the-icons-margin-formatter))
#+END_SRC

** Syntax Checking
#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :straight t
    :init
    (setq flycheck-buffer-switch-check-intermediate-buffers t)
    :hook
    (prog-mode-hook . flycheck-mode)
    :config
    (delq 'new-line flycheck-check-syntax-automatically))
#+END_SRC

** Lsp Server Config
[[https://emacs-lsp.github.io/lsp-mode/tutorials/how-to-turn-off/][lsp display config]]
#+BEGIN_SRC emacs-lisp
  (use-package lsp-mode
    :straight t
    :init
    (setq lsp-auto-guess-root t
          lsp-prefer-flymake nil
          lsp-auto-configure t
          ;; ç¬¦å·é«˜äº®
          lsp-enable-symbol-highlighting t
          lsp-symbol-highlighting-skip-current t
          ;; å…³é—­åº•éƒ¨eldoc æç¤º
          lsp-eldoc-enable-hover nil
          ;; å…³é—­çŠ¶æ€æ ä»£ç æ“ä½œæç¤º
          lsp-modeline-code-actions-enable nil
          ;; å…³é—­çŠ¶æ€æ è¯Šæ–­æç¤º
          lsp-modeline-diagnostics-enable nil
          ;; å…³é—­æ¨¡æ¿ç”Ÿæˆ
          lsp-enable-snippet t
          ;; å…³é—­æŠ˜å 
          lsp-enable-folding nil
          ;; å…³é—­ minibuffer ç­¾åå’Œæ–‡æ¡£æ˜¾ç¤º
          lsp-signature-auto-activate nil
          ;; å…³é—­ lens
          lsp-lens-enable nil
          ;; å…³é—­ headerline
          lsp-headerline-breadcrumb-enable nil
          )
    :hook
    ;; lsp-deferred ç­‰å¾…bufferå®Œå…¨å¯è§åå¯ç”¨ lsp
    ((c-mode-hook python-mode) . lsp-deferred)
    (lsp-mode . lsp-enable-which-key-integration)
    :config
    ;; (delq 'company-capf company-backends)
    ;; (add-to-list 'company-backends 'company-capf)
    (lmm/evil-space-leader-def
      "ls" 'lsp-signature-activate)
    (set-face-attribute 'lsp-face-highlight-textual nil
                        :background nil
                        :underline '(:color "#fce38a" :position 0)
                        :foreground nil
                        )
    ;; (set-face-attribute 'lsp-face-highlight-write nil :background nil)
    ;; (set-face-attribute 'lsp-face-highlight-read nil :background nil)
    :commands lsp)

  (use-package lsp-ui
    :straight t
    :init
    ;; é”™è¯¯æ£€æŸ¥æç¤ºå»¶è¿Ÿ
    (setq lsp-ui-sideline-delay 0.4
          ;; æ“ä½œæç¤º
          lsp-ui-sideline-show-code-actions nil)
    :commands lsp-ui-mode
    :config
    (setq lsp-ui-sideline-actions-icon lsp-ui-sideline-actions-icon-default)
    (lmm/evil-space-leader-def
      "lds" 'lsp-ui-doc-show
      "ldh" 'lsp-ui-doc-hide
      ))

  (use-package eglot
    :disabled
    :no-require t
    :straight t
    :commands eglot eglot-ensure)
#+END_SRC

** Tree Sitter
#+BEGIN_SRC emacs-lisp
  (use-package tree-sitter
    :straight t
    :commands (tree-sitter-mode tree-sitter-hl-mode)
    :hook ((rust-mode-hook) . tree-sitter-hl-mode)
    )
  (use-package tree-sitter-langs
    :straight t
    :commands tree-sitter-mode)
  (use-package evil-textobj-tree-sitter
    :straight t
    :after tree-sitter
    :config

    ;; ä»£ç å—
    ;; block.inner
    ;; block.outer
    ;; å‡½æ•°è°ƒç”¨
    ;; call.inner
    ;; call.outer
    ;; å¯¹è±¡å—
    ;; class.inner
    ;; class.outer
    ;; æ³¨é‡Š
    ;; comment.outer
    ;; æ¡ä»¶è¡¨è¾¾æ—¶
    ;; conditional.inner
    ;; conditional.outer
    ;; å‡½æ•°
    ;; function.inner
    ;; function.outer
    ;; å¾ªç¯
    ;; loop.inner
    ;; loop.outer
    ;; å‚æ•°
    ;; parameter.inner
    ;; è¯­å¥è¡Œ
    ;; statement.outer
    (evil-define-key nil evil-inner-text-objects-map
      "f" (evil-textobj-tree-sitter-get-textobj "function.inner")
      "p" (evil-textobj-tree-sitter-get-textobj "parameter.inner")
      "c" (evil-textobj-tree-sitter-get-textobj "class.inner")
      "?" (evil-textobj-tree-sitter-get-textobj "conditional.inner")
      "r" (evil-textobj-tree-sitter-get-textobj "call.inner")
      ";" (evil-textobj-tree-sitter-get-textobj "statement.outer")
      "/" (evil-textobj-tree-sitter-get-textobj "comment.outer")
      "0" (evil-textobj-tree-sitter-get-textobj "loop.inner")
      "b" (evil-textobj-tree-sitter-get-textobj "block.inner"))
    (evil-define-key nil evil-outer-text-objects-map
      "f" (evil-textobj-tree-sitter-get-textobj "function.outer")
      "p" (evil-textobj-tree-sitter-get-textobj "parameter.outer")
      "c" (evil-textobj-tree-sitter-get-textobj "class.outer")
      "?" (evil-textobj-tree-sitter-get-textobj "conditional.outer")
      "r" (evil-textobj-tree-sitter-get-textobj "call.outer")
      ";" (evil-textobj-tree-sitter-get-textobj "statement.outer")
      "/" (evil-textobj-tree-sitter-get-textobj "comment.outer")
      "0" (evil-textobj-tree-sitter-get-textobj "loop.outer")
      "b" (evil-textobj-tree-sitter-get-textobj "block.outer"))
    (evil-define-key '(normal motion visual) 'global
      "L" (lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "parameter.inner"))
      "H" (lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "parameter.inner" t))
      ";f"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "function.outer"))
      ",f"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "function.outer" t))
      ";F"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "function.outer" nil t))
      ",F"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "function.outer" t t))
      ";r"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "call.outer"))
      ",r"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "call.outer" t))
      ";/"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "comment.outer"))
      ",/"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "comment.outer" t))
      ";;"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "statement.outer"))
      ",;"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "statement.outer" t))
      ";0"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "loop.outer"))
      ",0"(lambda()(interactive)(evil-textobj-tree-sitter-goto-textobj "loop.outer" t))))
#+END_SRC

** LANG
*** javascript
#+BEGIN_SRC
#+END_SRC

*** rust
#+BEGIN_SRC emacs-lisp
  (use-package rust-mode
    :straight t
    :commands rust-mode
    )
  (use-package rustic
    :straight t
    :mode
    ("\\.rs$" . rustic-mode)
    :init
    ;; (setq rustic-lsp-server 'rls)
    (setq rustic-lsp-client 'lsp)
    ;; (setq rustic-lsp-client 'eglot)
    :commands rustic-mode
    :config
    (add-hook 'rust-mode-hook (lambda () (setq-local company-backends '(company-capf
                                                                          (company-yasnippet company-dabbrev-code company-keywords)
                                                                          company-dabbrev
                                                                          company-files
                                                                          ))))
    (general-define-key
     :keymaps 'rustic-mode-map
     "<f5>" '(lambda ()(interactive) (save-buffer)(rustic-cargo-run)))

    (setq rustic-indent-method-chain t)
    (setq rustic-babel-format-src-block nil
          rustic-format-trigger nil)
    ;; hook å¼•å…¥å¤ªæ—©å®¹æ˜“å‡ºç°é—®é¢˜
    ;; (remove-hook 'rustic-mode-hook #'flycheck-mode)
    ;; (remove-hook 'rustic-mode-hook #'flymake-mode-off)
    ;; (unless (featurep 'lsp)
    ;;   (add-to-list 'flycheck-checker 'rustic-clippy))
    ;; (when (featurep 'lsp)
    ;;   (setq lsp-rust-analyzer-cargo-watch-command 'clippy)
    ;;   (remove-hook 'rustic-mode-hook #'rustic-setup-lsp)
    ;;   (add-hook 'rustic-mode-local-vars-hook #'rustic-setup-lsp))
    )
#+END_SRC

*** emacs-lisp
#+BEGIN_SRC emacs-lisp
  (add-hook 'emacs-lisp-mode-hook (lambda ()
                                    (setq-local company-backends '(company-elisp
                                                                   company-files
                                                                   (company-dabbrev-code company-keywords company-dabbrev)
                                                                   company-capf))))
#+END_SRC

*** lua
#+BEGIN_SRC emacs-lisp
  (use-package lua-mode
    :straight t
    :init
    (add-to-list 'auto-mode-alist '("\\.lua$" . lua-mode))
    (add-to-list 'interpreter-mode-alist '("lua" . lua-mode))
    (setq lua-indent-level 2)
    (setq lua-indent-string-contents t)
    (setq lua-indent-close-paren-align nil)
    :commands lua-mode)
#+END_SRC

*** markdown-mode
#+BEGIN_SRC emacs-lisp
  (use-package markdown-mode
    :straight t
    :commands markdown-mode
    :mode
    ("README\\.md\\'" . gfm-mode)
    :init (setq markdown-command "multimarkdown"))
#+END_SRC

*** json-mode
#+BEGIN_SRC emacs-lisp
  (use-package json-mode
    :commands json-mode
    :straight t)
#+END_SRC

*** web
#+BEGIN_SRC emacs-lisp
  (use-package verb
    :straight t
    :init
    (setq verb-babel-timeout 3.0)
    :commands verb-mode)
#+END_SRC

* PROJECT CONFIG
** Projectile Config
#+BEGIN_SRC emacs-lisp
  (use-package projectile
    :straight t
    :hook
    (after-init-hook . projectile-mode)
    :init
    (setq-default projectile-mode-line-prefix " Proj")
    :config
    (when (executable-find "rg")
      (setq-default projectile-generic-command "rg --files --hidden"))

    (lmm/evil-space-leader-def
      "p" projectile-command-map)
    (general-define-key
     :keymaps 'projectile-command-map
     "A" #'projectile-add-known-project))

  (use-package ibuffer-projectile
    :straight t
    :after projectile)
#+END_SRC

* DIRED CONFIG
é¿å…åœ¨ dired ä¸­å‰è¿›å’Œåé€€æ–°å»º buffer
#+BEGIN_SRC emacs-lisp
  (put 'dired-find-alternate-file 'disabled nil)
  (use-package dired
    :init
    (setq dired-listing-switches "-alh")
    :commands (dired dired-jump)
    :config
    (defun lmm/dired-up-alternate()
      "Dired up directory -- alternate"
      (interactive)
      (if (equal major-mode 'dired-mode)
          (find-alternate-file "..")
        (message "You not in dired-mode")))

    (defun lmm/dired-find-alternate-file-if-directory()
      "dired-mode:
    dired-find-alternate-file if you select is a directory"
      (interactive)
      (if (equal major-mode 'dired-mode)
          (if (file-directory-p (dired-get-filename))
              (dired-find-alternate-file)
            (when (yes-or-no-p "This is a file, you sure open this file?")
              (dired-find-file)))
        (message "You not in dired-mode")))
    (general-define-key
     :states '(normal motion)
     :keymaps 'dired-mode-map
     "h" 'lmm/dired-up-alternate
     "l" 'lmm/dired-find-alternate-file-if-directory))

  ;; (with-eval-after-load 'dired
  ;;   (define-key dired-mode-map (kbd "<return>") 'dired-find-alternate-file)
  ;;   (define-key dired-mode-map (kbd "-") (lambda () (interactive)
  ;;                                          (find-alternate-file ".."))))
  ;; (add-hook 'dired-mode-hook (lambda ()
  ;;                              (define-key evil-normal-state-local-map (kbd "-")
  ;;                                          (lambda () (interactive)
  ;;                                            (find-alternate-file "..")))))
#+END_SRC

* WITH-EDITOR
#+BEGIN_SRC emacs-lisp
  ;; å¯¼å‡ºç¯å¢ƒå˜é‡ ï¼ï¼ EDITOR
  (use-package with-editor
    :straight t
    :hook
    (shell-mode-hook . with-editor-export-editor)
    (eshell-mode-hook . with-editor-export-editor)
    (term-exec-hook . with-editor-export-editor)
    (vterm-mode-hook . with-editor-export-editor)
    :config
    ;; (shell-command-with-editor-mode)
    ;; (define-key (current-global-map)
    ;;             [remap async-shell-command] 'with-editor-async-shell-command)
    ;; (define-key (current-global-map)
    ;;             [remap shell-command] 'with-editor-shell-command)
    )
#+END_SRC

* ENVIRONMENT SAVE
ä¿å­˜æ‰“å¼€è¿‡çš„å…‰æ ‡ä½ç½®
#+BEGIN_SRC emacs-lisp
  (use-package saveplace
    :hook
    (after-init-hook . save-place-mode))
#+END_SRC
ä¿å­˜æ‰“å¼€è¿‡çš„æ–‡ä»¶
#+BEGIN_SRC emacs-lisp
  (use-package recentf
    :hook
    (after-init-hook . recentf-mode)
    :init
    (setq recentf-max-saved-items 100
          recentf-auto-cleanup 'never))
#+END_SRC

* GIT
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :straight t
    :init
    (setq-default magit-diff-refine-hunk t)
    :commands magit-status magit-dispatch
    :bind
    (:map lmm/evil-space-leader-def-map
          ("gd" . magit-dispatch)
          ("gs" . magit-stage))
    )
#+END_SRC

* DIFF
#+BEGIN_SRC emacs-lisp
  (use-package diff-hl
    :straight t
    :hook
    (after-init-hook . global-diff-hl-mode)
    (dired-mode-hook . diff-hl-dired-mode-unless-remote)
    (magit-pre-refresh-hook . diff-hl-magit-pre-refresh)
    (magit-post-refresh-hook . diff-hl-magit-post-refresh)
    :config
    (evil-define-key '(normal motion) diff-hl-show-hunk-map
      "n" #'diff-hl-show-hunk-next
      "p" #'diff-hl-show-hunk-previous
      "r" #'diff-hl-revert-hunk
      "c" #'diff-hl-show-hunk-copy-original-text
      "q" 'diff-hl-inline-popup-hide
      (kbd "<escape>") 'diff-hl-inline-popup-hide
      "j" 'diff-hl-inline-popup--popup-down
      "k" 'diff-hl-inline-popup--popup-up
      (kbd "C-f") 'diff-hl-inline-popup--popup-pagedown
      (kbd "C-b") 'diff-hl-inline-popup--popup-pageup)
    (lmm/evil-space-leader-def
      "ds" #'diff-hl-show-hunk))
#+END_SRC

* WORKSPACE
** Perspective
#+BEGIN_SRC emacs-lisp
  (use-package perspective
    :straight t
    :init
    ;; æŒ‰æœ€è¿‘ä½¿ç”¨æ’åºbuffer
    (setq persp-sort 'access
          ;; æ˜¯å¦åœ¨modelineä¸­æ˜¾ç¤º
          persp-show-modestring t
          persp-suppress-no-prefix-key-warning t)
    ;; :hook
    ;; (after-init-hook . persp-mode)
    :after consult
    :config
    (progn
      (persp-mode t)
      ;; consult buffers by persp
      (defvar lmm/perspective-consult--source-buffer
        `(:name     ,(format "Buffers ( %s )" (persp-current-name))
                    :narrow   ?b
                    :category buffer
                    :face     consult-buffer
                    :history  buffer-name-history
                    :state    ,#'consult--buffer-state
                    :default  t
                    :items
                    ,(lambda ()(interactive) (persp-current-buffer-names)))
        "Buffer candidate source for `persp-buffers'.")


      (defcustom lmm/perspective-consult-buffer-sources
        '(lmm/perspective-consult--source-buffer
          consult--source-recent-file
          consult--source-bookmark
          consult--source-project-buffer
          consult--source-project-recent-file)
        "Sources used by `consult-buffer'.
  See also `consult-project-buffer-sources'.
  See `consult--multi' for a description of the source data structure."
        :type '(repeat symbol))

      (general-define-key
       :keymaps 'perspective-map
       "<tab>" 'persp-switch
       "d" (lambda ()(interactive)(persp-kill (persp-current-name))))
      (lmm/evil-space-leader-def
        ;; "," (lambda ()(interactive)(consult-buffer lmm/perspective-consult-buffer-sources))
        "," 'persp-switch-to-buffer*
        "<" 'persp-switch-to-buffer
        "<tab>" perspective-map)
      ))
#+END_SRC

** Treemacs -- æ–‡ä»¶æ ‘
#+BEGIN_SRC emacs-lisp
  (use-package treemacs
    :straight t
    :defer t
    :bind
    (:map lmm/evil-space-leader-def-map
          (";" . treemacs-select-window)))
  (use-package treemacs-evil
    :straight t
    :after (treemacs evil)
    :config
    (define-key evil-treemacs-state-map (kbd "q") 'treemacs-quit))

  (use-package treemacs-icons-dired
    :straight t
    :hook
    (dired-mode-hook . treemacs-icons-dired-enable-once))
#+END_SRC

* POPUP
#+BEGIN_SRC emacs-lisp
  (use-package popup
    :straight t
    :no-require t)
#+END_SRC

* TERM
** Install
#+BEGIN_SRC emacs-lisp
  (use-package vterm
    :straight t
    :init
    (general-define-key
     "<f12>" #'vterm)
    (setq vterm-timer-delay 0.05)
    (add-to-list 'evil-insert-state-modes 'vterm-mode)
    :config
    (add-to-list 'display-buffer-alist
                 '("\\*vterm\\*\\(<[0-9]>\\)?$"
                   display-buffer-at-bottom))
    (general-define-key
     :keymaps 'vterm-mode-map
     "<f12>" (lambda ()(interactive) (if (one-window-p)
                            (switch-to-buffer (other-buffer))
                            (delete-window)))
     "C-h" #'vterm-send-C-h
     "C-y" #'vterm-send-C-y
     "M-y" #'vterm-send-M-y
     )
     (add-hook 'vterm-exit-functions
               (lambda (buffer &optional arg)
                 "Vterm exit command will call interactive func 'delete-window'"
                 (when (not (one-window-p))
                   (call-interactively 'delete-window))))
     (evil-make-intercept-map vterm-mode-map 'insert)
    :commands vterm)
#+END_SRC

** COMMENT Zsh Needed Config
#+BEGIN_SRC conf
  vterm_printf(){
      if [ -n "$TMUX" ] && ([ "${TERM%%-*}" = "tmux" ] || [ "${TERM%%-*}" = "screen" ] ); then
          # Tell tmux to pass the escape sequences through
          printf "\ePtmux;\e\e]%s\007\e\\" "$1"
      elif [ "${TERM%%-*}" = "screen" ]; then
          # GNU screen (screen, screen-256color, screen-256color-bce)
          printf "\eP\e]%s\007\e\\" "$1"
      else
          printf "\e]%s\e\\" "$1"
      fi
  }
  vterm_prompt_end() {
      vterm_printf "51;A$(whoami)@$(cat /etc/hostname):$(pwd)";
  }
  setopt PROMPT_SUBST
  PROMPT=$PROMPT'%{$(vterm_prompt_end)%}'

  vterm_cmd() {
      local vterm_elisp
      vterm_elisp=""
      while [ $# -gt 0 ]; do
          vterm_elisp="$vterm_elisp""$(printf '"%s" ' "$(printf "%s" "$1" | sed -e 's|\\|\\\\|g' -e 's|"|\\"|g')")"
          shift
      done
      vterm_printf "51;E$vterm_elisp"
  }
#+END_SRC

* UTILS
** ç¿»è¯‘
#+BEGIN_SRC emacs-lisp
  (defun lmm/translate-word-at-point (p)
    (interactive "P")
    (let ((word (word-at-point p))
          valuestr)
      (if word
          (setq valuestr (shell-command-to-string (concat "sdcv -e -u æœ—é“è‹±æ±‰å­—å…¸5.0 " (downcase word))))
        (setq valuestr "word not found at point"))
      (if (featurep 'popup)
          (popup-tip valuestr)
        (message valuestr)))
    )

  ;; C-x 8 RET is insert-char, have unicode
  ;; (defun lmm/consult-display-unicode ()
  ;;   "display unicode by consult"
  ;;   (interactive)
  ;;   (let ((names (ucs-names))
  ;;         (char-alias ()))
  ;;     (maphash (lambda (name char)
  ;;                (push (cons (format "0x%06X\t%s\t%s" char (char-to-string char) name) char) char-alias))
  ;;              names)
  ;;     (completing-read "Unicode Display: " (sort char-alias (lambda (a b)
  ;;                                                             (< (cdr a) (cdr b)))))))

  ;;;###autoload
  (defun lmm/rename-buffer-and-file-name(&optional buffer file newfile)
    "Rename current BUFFER name and FILE name for NEWFILE."
    (interactive (let* ((buffer (current-buffer))
                        (file (buffer-file-name))
                        (newfile (and file
                                      (expand-file-name (read-file-name "File and Buffer New Name: ")))))
                   (list buffer file newfile)))
    ;; è¯»å–æ–°æ–‡ä»¶å
    (if (and buffer file newfile)
        ;; å¦‚æœæ–°æ–‡ä»¶åä¸ºæ–‡ä»¶å¤¹åˆ™æ”¾å¼ƒ
        (if (not (directory-name-p newfile))
            (if-let ((newfile-dir (file-name-directory newfile)))
                ;; åˆ¤æ–­æ–°æ–‡ä»¶åæ‰€åœ¨æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
                (if (file-directory-p newfile-dir)
                    (progn
                      (rename-file file newfile 4)
                      (with-current-buffer buffer
                        ;; æ›´æ”¹ç¼“å†²åŒºæ‰€åœ¨æ–‡ä»¶è·¯å¾„ï¼ŒåŒæ—¶æ›´æ”¹ç¼“å†²åŒºåç§°
                        (set-visited-file-name newfile)
                        ;; (rename-buffer (file-name-nondirectory newfile))
                        ))
                  ;; æ˜¯å¦åˆ›å»ºæ–°çš„æ–‡ä»¶å¤¹
                  (when (yes-or-no-p
                         (format "\"%s\" directory is not exists, you sure make the new directory?"
                                 newfile-dir))
                    (make-directory newfile-dir)
                    (rename-file file newfile 4)
                    (with-current-buffer buffer
                      (set-visited-file-name newfile)
                      ))))
          (message "\"%s\" is a directory ! ! !" newfile))))


  (use-package evil
    :config
    (lmm/evil-space-leader-def
      "tw" 'lmm/translate-word-at-point
      "cf" 'lmm/rename-buffer-and-file-name))

#+END_SRC

** æ–‡ä»¶æ“ä½œ
#+BEGIN_SRC emacs-lisp
  (defun lmm/open-file-in-remote-sudo(file)
    "Open FILE as remote root"
    (interactive)
    (find-file (if (file-remote-p file)
                   (concat "/" (file-remote-p file 'method) ":"
                           (file-remote-p file 'user) "@" (file-remote-p file 'host)
                           "|sudo:root@"
                           (file-remote-p file 'host) ":" (file-remote-p file 'localname))
                 (user-error "This is not remote file"))))


  (defvar lmmv/sudo-localhost "/sudo:root@localhost:"
    "Sudo localhost name")

  (defun lmm/open-file-in-localhost-sudo(file)
    "Open FILE as root"
    (interactive)
    (find-file (concat lmmv/sudo-localhost (expand-file-name file))))

  (defun lmm/conver-sudo-file-name(file)
    "Conver FILE to sudo path"
    (concat lmmv/sudo-localhost (expand-file-name file)))

;;;###autoload
  (defun lmm/sudo-find-file (file)
    "Open FILE as root."
    (interactive "FOpen file as root: ")
    (let ((file (expand-file-name file)))
      (cond
       ;; å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹å¹¶å­˜åœ¨
       ((file-directory-p file)
        (lmm/read-char-choice
            (format "\"%s\" is directory, sure open in sudo('y' -> yes, '.' -> not sudo open, 'n' or 'q' -> quit)" file)
          ((?y (lmm/open-file-in-localhost-sudo file))
           (?. (find-file file))
           (?n nil)
           (?q nil))))

       ;; å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ä½†ä¸å­˜åœ¨
       ((directory-name-p file)
        (lmm/read-char-choice
            (format "\"%s\" is new directory, sure make it on sudo('y':make sudo + sudo open, '.':make + open, 'r':make sudo, 'u':make, 'n'|'q':quit)?" file)
          ((?y (let ((fs (lmm/conver-sudo-file-name file)))
                 (make-directory fs t)
                 (if (file-directory-p fs)
                     (find-file fs)
                   (user-error (format "\"%s create filed!\"" file)))))
           (?. (make-directory file t)
               (if (file-directory-p file)
                   (find-file file)
                 (user-error (format "\"%s create filed!\"" file))))
           (?r (make-directory (lmm/conver-sudo-file-name file) t))
           (?u (make-directory file t))
           (?n nil)
           (?q nil))))

       ;; å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¹¶ç›´æ¥å¯å†™
       ((file-writable-p file)
        (lmm/read-char-choice
            (format "File \"%s\" is user writeable, sure open in sudo('y':sudo open, '.':open, 'n'|'q':quit)?" file)
          ((?y (lmm/open-file-in-localhost-sudo file))
           (?. (find-file file))
           (?n nil)
           (?q nil))))

       ;; å¦‚æœæ˜¯ä¸€ä¸ªæ–‡ä»¶å¹¶ä¸èƒ½ç›´æ¥å¯å†™
       ((file-exists-p file) (lmm/open-file-in-localhost-sudo file))

       ;; å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨
       (t nil)
       )))
#+END_SRC

** News
#+BEGIN_SRC emacs-lisp
  (use-package elfeed
    :straight t
    :init
    (setq elfeed-db-directory (concat user-emacs-directory "elfeed-cache"))
    :commands elfeed)
#+END_SRC

* KEY LIST
+ word case
  - M-u upcase-dwim è½¬æ¢å•è¯æˆ–è€…æ ‡è®°åŒºåŸŸä¸ºå¤§å†™
  - C-U capitalize-dwim è½¬æ¢å•è¯æˆ–è€…æ ‡è®°åŒºåŸŸæ‰€æœ‰å•è¯é¦–ä¸ªå­—æ¯ä¸ºå¤§å†™
